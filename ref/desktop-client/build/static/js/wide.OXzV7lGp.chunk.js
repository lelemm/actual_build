import{j as e,r as u,v as et,W as mt,e as bs,E as Xe,bA as mn,V as g,ao as yt,bB as ws,t as m,s as G,bC as Nt,bD as yn,aV as ze,aW as tt,bE as js,as as vs,bF as tn,a6 as K,ab as ie,d as V,bG as nt,aa as je,bH as Ge,bI as Ot,bJ as bt,J as Be,bK as wt,ax as bn,T as X,bL as nn,ad as ce,bM as Ss,bN as Cs,bO as Ts,z as Ht,bP as ks,bQ as Wt,H as st,bR as sn,bS as Bs,bT as an,x as Ms,bU as Rs,bV as re,bW as wn,bX as As,bY as Is,a5 as Je,bZ as Ps,b_ as Ds,b$ as on,aD as at,aG as ve,aH as ue,c0 as ke,c1 as Es,aN as jt,i as De,M as ot,c2 as Ue,c3 as We,aO as jn,c4 as Ls,c5 as vn,c6 as it,c7 as $t,a9 as rt,aK as Ee,aE as ae,c8 as _s,n as Sn,c9 as Fs,ca as Ns,cb as Os,cc as Hs,cd as Ws,aM as Qe,G as Cn,ce as $s,aT as Dt,aU as Gs,cf as Us,aY as rn,a_ as zs,b1 as Qs,aQ as Le,b2 as ln,b5 as Vs,a$ as Zs,b0 as cn,aZ as qs,b3 as Ks,b4 as Ys,cg as Xs,ch as Tn,ci as Js,aj as ea,cj as kn,ck as ta,bb as be,cl as na,ar as dn,b6 as $e,g as sa,cm as Bn,cn as Mn,co as Ke,cp as Rn,cq as aa,cr as gt,cs as Gt,ct as un,cu as Ut,bu as He,cv as he,cw as oa,cx as Ie,cy as vt,cz as An,cA as In,cB as Pn,o as zt,cC as ia,cD as ra,cE as la,K as Pe,f as ca,p as Dn,cF as da,cG as ua,cH as ha,cI as Qt,cJ as pa,O as Et,cK as St,cL as fa,cM as ga,cN as xa,cO as ma,cP as En,cQ as ya,cR as ba,cS as wa,cT as Lt,cU as ja,cV as va,cW as xt,a7 as Sa,a8 as Ca,ae as Mt,cX as Ta,cY as ka,q as xe,w as Ba,cZ as Ma,b7 as Ra,c_ as Aa,c$ as Ln,d0 as Ia,bc as Pa,A as Da,by as Ea,ah as La,I as _a,ac as Fa,ba as Na,bk as Oa,d1 as Ha,bh as Wa,bj as $a,b as de,bl as Ga,bm as Ua,d2 as za,bq as Qa,d3 as _n,d4 as Va,d5 as Za,d6 as hn,d7 as pn,d8 as qa,d9 as Ka}from"./index.15_rIw78.js";import{da as yi}from"./index.15_rIw78.js";import{u as Ya}from"./usePreviewTransactions.9E3yxDt5.chunk.js";import{t as Xa,A as Ja,F as eo,M as fn}from"./AppliedFilters.oK31yeZv.chunk.js";const to=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 91 51",style:{color:"inherit",...n.style},children:e.jsx("path",{fill:"currentColor",d:"M30.256 48.614a3.14 3.14 0 0 0-.989-2.153L10.803 29.063h76.915a3.2 3.2 0 0 0 .315 0c1.584-.084 2.95-1.64 2.867-3.266-.082-1.625-1.598-3.028-3.182-2.943H10.803L29.267 5.49c1.284-1.099 1.456-3.057.385-4.373a2.972 2.972 0 0 0-4.48-.187L.971 23.695a3.163 3.163 0 0 0 0 4.56l24.2 22.766a2.98 2.98 0 0 0 2.205.84c1.669-.08 2.958-1.534 2.88-3.247Z"})}),no=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",style:{color:"inherit",...n.style},children:e.jsx("path",{d:"m9 16.172-6.071-6.071-1.414 1.414L10 20l.707-.707 7.778-7.778-1.414-1.414L11 16.172V0H9z",fill:"currentColor"})}),so=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",style:{color:"inherit",...n.style},children:e.jsx("path",{d:"M9 3.828 2.929 9.899 1.515 8.485 10 0l.707.707 7.778 7.778-1.414 1.414L11 3.828V20H9V3.828z",fill:"currentColor"})}),Fn=n=>e.jsxs("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:[e.jsx("path",{d:"M12 13.584a2.643 2.643 0 0 1-1.875-.775L.584 3.268a1.768 1.768 0 0 1 2.5-2.5l8.739 8.739a.25.25 0 0 0 .354 0L20.916.768a1.768 1.768 0 0 1 2.5 2.5l-9.541 9.541a2.643 2.643 0 0 1-1.875.775Z",fill:"currentColor"}),e.jsx("path",{d:"M12 23.75a2.643 2.643 0 0 1-1.875-.775L.584 13.434a1.768 1.768 0 0 1 2.5-2.5l8.739 8.739a.25.25 0 0 0 .354 0l8.739-8.739a1.768 1.768 0 0 1 2.5 2.5l-9.541 9.541A2.643 2.643 0 0 1 12 23.75Z",fill:"currentColor"})]}),ao=n=>e.jsxs("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:[e.jsx("path",{d:"M13.584 12a2.643 2.643 0 0 1-.775 1.875l-9.541 9.541a1.768 1.768 0 0 1-2.5-2.5l8.739-8.739a.25.25 0 0 0 0-.354L.768 3.084a1.768 1.768 0 0 1 2.5-2.5l9.541 9.541A2.643 2.643 0 0 1 13.584 12Z",fill:"currentColor"}),e.jsx("path",{d:"M23.75 12a2.643 2.643 0 0 1-.775 1.875l-9.541 9.541a1.768 1.768 0 0 1-2.5-2.5l8.739-8.739a.25.25 0 0 0 0-.354l-8.739-8.739a1.768 1.768 0 0 1 2.5-2.5l9.541 9.541A2.643 2.643 0 0 1 23.75 12Z",fill:"currentColor"})]}),Nn=n=>e.jsxs("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:[e.jsx("path",{d:"M12 10.416a2.643 2.643 0 0 1 1.875.775l9.541 9.541a1.768 1.768 0 0 1-2.5 2.5l-8.739-8.739a.25.25 0 0 0-.354 0l-8.739 8.739a1.768 1.768 0 0 1-2.5-2.5l9.541-9.541A2.643 2.643 0 0 1 12 10.416Z",fill:"currentColor"}),e.jsx("path",{d:"M12 .25a2.643 2.643 0 0 1 1.875.775l9.541 9.541a1.768 1.768 0 0 1-2.5 2.5l-8.739-8.739a.25.25 0 0 0-.354 0l-8.739 8.739a1.768 1.768 0 0 1-2.5-2.5l9.541-9.541A2.643 2.643 0 0 1 12 .25Z",fill:"currentColor"})]}),oo=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:e.jsx("path",{fill:"currentColor",d:"M19.611 2.571h-3.754a1.286 1.286 0 1 1 0-2.571h6.857A1.286 1.286 0 0 1 24 1.286v6.857a1.286 1.286 0 0 1-2.571 0V4.39L15.48 10.34a1.286 1.286 0 0 1-1.817-1.817l5.948-5.95ZM1.286 14.571a1.286 1.286 0 0 1 1.285 1.286v3.754l5.949-5.946a1.286 1.286 0 0 1 1.817 1.817L4.39 21.429h3.753a1.285 1.285 0 1 1 0 2.571H1.286A1.286 1.286 0 0 1 0 22.714v-6.857a1.286 1.286 0 0 1 1.286-1.286Z"})}),io=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:e.jsx("path",{fill:"currentColor",d:"M14.143 1.714A1.286 1.286 0 0 1 15.429 3v3.753L21.806.377a1.286 1.286 0 0 1 1.817 1.817l-6.376 6.377H21a1.286 1.286 0 1 1 0 2.572h-6.857a1.286 1.286 0 0 1-1.286-1.286V3a1.286 1.286 0 0 1 1.286-1.286ZM9.857 22.286A1.285 1.285 0 0 1 8.571 21v-3.753l-6.377 6.376a1.286 1.286 0 0 1-1.817-1.817l6.376-6.377H3a1.286 1.286 0 0 1 0-2.572h6.857a1.286 1.286 0 0 1 1.286 1.286V21a1.286 1.286 0 0 1-1.286 1.286Z"})}),ro=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 19 24",style:{color:"inherit",...n.style},children:e.jsx("path",{fill:"currentColor",d:"M17 24H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h9a1 1 0 0 1 .707.293l7 7A1 1 0 0 1 19 8v14a2 2 0 0 1-2 2ZM2 21.5a.5.5 0 0 0 .5.5h14a.5.5 0 0 0 .5-.5V9a.5.5 0 0 0-.5-.5h-4a2 2 0 0 1-2-2v-4A.5.5 0 0 0 10 2H2.5a.5.5 0 0 0-.5.5v19Z"})}),lo=n=>e.jsxs("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:[e.jsx("path",{d:"M8.616 1.741A1.455 1.455 0 0 1 10.07.287h3.392a1.455 1.455 0 0 1 1.453 1.454v8.228a.25.25 0 0 0 .25.25h2.9a1.138 1.138 0 0 1 .827 2l-6.1 6.1a1.489 1.489 0 0 1-2.056 0l-6.1-6.1a1.137 1.137 0 0 1 .827-2h2.9a.249.249 0 0 0 .25-.25Z",fill:"currentColor"}),e.jsx("path",{d:"M0 19.677a4.039 4.039 0 0 0 4.035 4.035h15.93A4.039 4.039 0 0 0 24 19.677V17.8a1.225 1.225 0 0 0-2.449 0v1.874a1.588 1.588 0 0 1-1.586 1.586H4.035a1.588 1.588 0 0 1-1.586-1.586V17.8A1.225 1.225 0 0 0 0 17.8Z",fill:"currentColor"})]}),co=n=>e.jsxs("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:[e.jsx("path",{d:"M12.406 14.905a1 1 0 0 0-.543 1.307 1 1 0 0 1-.217 1.09l-2.828 2.829a2 2 0 0 1-2.828 0L3.868 18.01a2 2 0 0 1 0-2.829L6.7 12.353a1.013 1.013 0 0 1 1.091-.217 1 1 0 0 0 .763-1.849 3.034 3.034 0 0 0-3.268.652l-2.832 2.828a4.006 4.006 0 0 0 0 5.657l2.122 2.121a4 4 0 0 0 5.656 0l2.829-2.828a3.008 3.008 0 0 0 .651-3.27 1 1 0 0 0-1.306-.542Z",fill:"currentColor"}),e.jsx("path",{d:"M7.757 16.241a1.011 1.011 0 0 0 1.414 0l7.779-7.778a1 1 0 0 0-1.414-1.414l-7.779 7.778a1 1 0 0 0 0 1.414Z",fill:"currentColor"}),e.jsx("path",{d:"m21.546 4.574-2.121-2.121a4.006 4.006 0 0 0-5.657 0l-2.829 2.828a3.006 3.006 0 0 0-.651 3.269 1 1 0 1 0 1.849-.764 1 1 0 0 1 .217-1.086l2.828-2.828a2 2 0 0 1 2.829 0l2.121 2.121a2 2 0 0 1 0 2.829L17.3 11.645a1.015 1.015 0 0 1-1.091.217 1 1 0 0 0-.765 1.849 3.026 3.026 0 0 0 3.27-.651l2.828-2.828a4.007 4.007 0 0 0 .004-5.658Z",fill:"currentColor"})]}),uo=n=>e.jsx("svg",{...n,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",style:{color:"inherit",...n.style},children:e.jsx("path",{d:"M15.067 3.986a.5.5 0 0 0-.354-.148.5.5 0 0 0-.354.147L3.437 14.91a.5.5 0 0 0 0 .707l4.948 4.948a.5.5 0 0 0 .707 0L20.009 9.648a.5.5 0 0 0 0-.706ZM2.43 16.8a.5.5 0 0 0-.489-.127.5.5 0 0 0-.351.364L.084 23.314a.5.5 0 0 0 .133.47.507.507 0 0 0 .47.132l6.272-1.5a.5.5 0 0 0 .237-.84ZM23.2 2.924 21.077.8a2.5 2.5 0 0 0-3.532 0l-1.418 1.417a.5.5 0 0 0 0 .707l4.95 4.949a.5.5 0 0 0 .707 0L23.2 6.454a2.5 2.5 0 0 0 0-3.53Z",fill:"currentColor"})}),ho=({startMonth:n,numDisplayed:t,monthBounds:s,style:o,onSelect:i})=>{const[r,l]=u.useState(null),[a,d]=u.useState(12),c=et(),f=n,h=mt(f,t-1),w=bs(Xe(f,a/2-t/2),mt(h,a/2-t/2)),v=Math.floor(w.length/2)-Math.floor(t/2),p=v+t-1,[S,b]=u.useState("small"),C=mn(P=>{b(P.width<=400?"small":"big"),d(Math.min(Math.max(Math.floor(P.width/50),12),24))}),B=[];return e.jsx(g,{style:{flexDirection:"row",alignItems:"center",justifyContent:"space-between",...o},children:e.jsx(g,{innerRef:C,style:{flexDirection:"row",flex:1,alignItems:"center",justifyContent:"center"},children:w.map((P,R)=>{const N=yt(P,"MMM"),T=R>=v&&R<=p,I=r+t-1,D=r===null?!1:R>=r&&R<=I,E=c===P,W=ws(P);let O=!1;B.includes(W)||(B.push(W),O=!0);const z=P>=s.start&&P<=s.end;return e.jsxs(g,{style:{padding:"3px 3px",width:S==="big"?"35px":"20px",textAlign:"center",userSelect:"none",cursor:"default",borderRadius:2,border:"none",...!z&&{textDecoration:"line-through",color:m.pageTextSubdued},...G.smallText,...T&&{backgroundColor:m.tableBorderHover,color:m.buttonPrimaryText},...(D||T)&&{borderRadius:0,cursor:"pointer"},...r!==null&&!D&&T&&{filter:"brightness(65%)"},...D&&!T&&{backgroundColor:m.buttonBareBackgroundHover},...D&&T&&{backgroundColor:m.tableBorderHover},...(R===v||R===r&&!T)&&{borderTopLeftRadius:2,borderBottomLeftRadius:2},...(R===p||R===I&&!T)&&{borderTopRightRadius:2,borderBottomRightRadius:2},...E&&{fontWeight:"bold"}},onClick:()=>i(P),onMouseEnter:()=>l(R),onMouseLeave:()=>l(null),children:[S==="small"?N[0]:N,O&&e.jsx(g,{style:{position:"absolute",top:-14,left:0,fontSize:10,fontWeight:"bold",color:z?m.pageText:m.pageTextSubdued},children:W})]},P)})})})},On=u.memo(({startMonth:n,onMonthSelect:t,numMonths:s,monthBounds:o})=>e.jsx(g,{style:{marginLeft:205,flexShrink:0},children:e.jsx(g,{style:{marginRight:5+Nt()},children:e.jsx(ho,{startMonth:n,numDisplayed:s,monthBounds:o,style:{paddingTop:5},onSelect:i=>t(i)})})}));On.displayName="BudgetPageHeader";function Ve({component:n,editingMonth:t,args:s,style:o}){const{months:i}=u.useContext(yn);return i.map((r,l)=>{const a=t===r;return e.jsx(ze.Provider,{value:tt(r),children:e.jsx(g,{style:{flex:1,borderLeft:"1px solid "+m.tableBorder,...o},children:e.jsx(n,{month:r,editing:a,...s})})},l)})}function lt({id:n,width:t=12,height:s=12,defaultColor:o=m.buttonNormalText,tooltipPosition:i="bottom start",style:r}){const l=u.useRef(null),[a,d]=u.useState(!1),c=js(n)||"",f=c&&c!=="",[h,w]=u.useState(c);u.useEffect(()=>w(c),[c]);function v(){V("notes-save",{id:n,note:h}),d(!1)}return e.jsxs(vs,{content:e.jsx(tn,{notes:c}),placement:i,triggerProps:{isDisabled:!f||a},children:[e.jsx(g,{style:{flexShrink:0},children:e.jsx(K,{ref:l,type:"bare","aria-label":"View notes",className:!f&&!a?"hover-visible":"",style:{color:o,...r,...f&&{display:"flex !important"},...a&&{color:m.buttonNormalText}},onClick:p=>{p.stopPropagation(),d(!0)},children:e.jsx(ro,{style:{width:t,height:s,flexShrink:0}})})}),e.jsx(ie,{triggerRef:l,isOpen:a,onOpenChange:v,placement:i,style:{padding:4},children:e.jsx(tn,{notes:h,editable:!0,focused:!0,onChange:w})})]})}function Vt({innerRef:n,category:t,categoryGroup:s,dragPreview:o,dragging:i,editing:r,style:l,isLast:a,onEditName:d,onSave:c,onDelete:f,onHideNewCategory:h}){const w=t.id==="new",[v,p]=u.useState(!1),S=u.useRef(null),b=e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",userSelect:"none",WebkitUserSelect:"none",opacity:t.hidden||s?.hidden?.33:void 0},children:[e.jsx("div",{"data-testid":"category-name",style:{textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",minWidth:0},children:t.name}),e.jsxs(g,{style:{flexShrink:0,marginLeft:5},ref:S,children:[e.jsx(K,{type:"bare",className:"hover-visible",onClick:C=>{C.stopPropagation(),p(!0)},style:{color:"currentColor",padding:3},children:e.jsx(nt,{width:14,height:14,style:{color:"currentColor"}})}),e.jsx(ie,{triggerRef:S,placement:"bottom start",isOpen:v,onOpenChange:()=>p(!1),style:{width:200},children:e.jsx(je,{onMenuSelect:C=>{C==="rename"?d(t.id):C==="delete"?f(t.id):C==="toggle-visibility"&&c({...t,hidden:!t.hidden}),p(!1)},items:[{name:"rename",text:"Rename"},!s?.hidden&&{name:"toggle-visibility",text:t.hidden?"Show":"Hide"},{name:"delete",text:"Delete"}]})})]}),e.jsx(g,{style:{flex:1}}),e.jsx(g,{style:{flexShrink:0},children:e.jsx(lt,{id:t.id,style:i&&{color:"currentColor"},defaultColor:m.pageTextLight})})]});return e.jsx(g,{innerRef:n,style:{width:200,overflow:"hidden","& .hover-visible":{display:"none"},...!i&&!o&&{"&:hover .hover-visible":{display:"flex"}},...i&&{color:m.formInputTextPlaceholderSelected},...o&&{backgroundColor:m.tableBackground,zIndex:1e4,borderRadius:6,overflow:"hidden"},...l},onKeyDown:C=>{C.key==="Enter"&&(d(null),C.stopPropagation())},children:e.jsx(Ge,{value:t.name,formatter:()=>b,width:"flex",exposed:r||w,onUpdate:C=>{w?C===""?h():C!==""&&c({...t,name:C}):C!==t.name&&c({...t,name:C})},onBlur:()=>d(null),style:{paddingLeft:13,...a&&{borderBottomWidth:0}},inputProps:{placeholder:w?"New Category Name":""}})})}function po({cat:n,categoryGroup:t,editingCell:s,dragState:o,MonthComponent:i,onEditName:r,onEditMonth:l,onSave:a,onDelete:d,onBudgetAction:c,onShowActivity:f,onDragChange:h,onReorder:w}){let v=o&&o.item===n;o&&o.item.id===n.cat_group&&(v=!0);const{dragRef:p}=Ot({type:"category",onDragChange:h,item:n,canDrag:s===null}),{dropRef:S,dropPos:b}=bt({types:"category",id:n.id,onDrop:w});return e.jsxs(Be,{innerRef:S,collapsed:!0,style:{backgroundColor:m.tableBackground,opacity:n.hidden||t?.hidden?.5:void 0},children:[e.jsx(wt,{pos:b,offset:{top:1}}),e.jsxs(g,{style:{flex:1,flexDirection:"row"},children:[e.jsx(Vt,{innerRef:p,category:n,categoryGroup:t,dragPreview:v&&o.preview,dragging:v&&!o.preview,editing:s&&s.cell==="name"&&s.id===n.id,onEditName:r,onSave:a,onDelete:d}),e.jsx(Ve,{component:i,editingMonth:s&&s.id===n.id&&s.cell,args:{category:n,onEdit:l,onBudgetAction:c,onShowActivity:f}})]})]})}function Zt({group:n,editing:t,collapsed:s,dragPreview:o,innerRef:i,style:r,onEdit:l,onSave:a,onDelete:d,onShowNewCategory:c,onHideNewGroup:f,onToggleCollapse:h}){const w=n.id==="new",[v,p]=u.useState(!1),S=u.useRef(null),b=e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",userSelect:"none",WebkitUserSelect:"none"},onClick:()=>{h(n.id)},children:[!o&&e.jsx(bn,{width:8,height:8,style:{marginRight:5,marginLeft:5,flexShrink:0,transition:"transform .1s",transform:s?"rotate(-90deg)":""}}),e.jsxs("div",{style:{textOverflow:"ellipsis",whiteSpace:"nowrap",overflow:"hidden",minWidth:0},children:[o&&e.jsx(X,{style:{fontWeight:500},children:"Group: "}),n.name]}),!o&&e.jsxs(e.Fragment,{children:[e.jsxs(g,{style:{marginLeft:5,flexShrink:0},ref:S,children:[e.jsx(K,{type:"bare",className:"hover-visible",onClick:C=>{C.stopPropagation(),p(!0)},style:{padding:3},children:e.jsx(nt,{width:14,height:14})}),e.jsx(ie,{triggerRef:S,placement:"bottom start",isOpen:v,onOpenChange:()=>p(!1),style:{width:200},children:e.jsx(je,{onMenuSelect:C=>{C==="rename"?l(n.id):C==="add-category"?c(n.id):C==="delete"?d(n.id):C==="toggle-visibility"&&a({...n,hidden:!n.hidden}),p(!1)},items:[{name:"add-category",text:"Add category"},{name:"rename",text:"Rename"},!n.is_income&&{name:"toggle-visibility",text:n.hidden?"Show":"Hide"},d&&{name:"delete",text:"Delete"}]})})]}),e.jsx(g,{style:{flex:1}}),e.jsx(g,{style:{flexShrink:0},children:e.jsx(lt,{id:n.id,style:o&&{color:"currentColor"},defaultColor:m.pageTextLight})})]})]});return e.jsx(g,{innerRef:i,style:{...r,width:200,backgroundColor:m.tableRowHeaderBackground,overflow:"hidden","& .hover-visible":{display:"none"},...!o&&{"&:hover .hover-visible":{display:"flex"}},...o&&{paddingLeft:10,zIndex:1e4,borderRadius:6,overflow:"hidden"}},onKeyDown:C=>{C.key==="Enter"&&(l(null),C.stopPropagation())},children:e.jsx(Ge,{value:n.name,formatter:()=>b,width:"flex",exposed:t,onUpdate:C=>{w?C===""?f():C!==""&&a({id:n.id,name:C}):a({id:n.id,name:C})},onBlur:()=>l(null),style:{fontWeight:600},inputProps:{style:{marginLeft:20},placeholder:w?"New Group Name":""}})})}function fo({group:n,collapsed:t,editingCell:s,dragState:o,MonthComponent:i,onEditName:r,onSave:l,onDelete:a,onDragChange:d,onReorderGroup:c,onReorderCategory:f,onToggleCollapse:h,onShowNewCategory:w}){const v=o&&o.item===n,{dragRef:p}=Ot({type:"group",onDragChange:d,item:n,canDrag:s===null}),{dropRef:S,dropPos:b}=bt({types:"group",id:n.id,onDrop:c}),{dropRef:C,dropPos:B}=bt({types:"category",id:n.id,onDrop:f,onLongHover:()=>{t&&h(n.id)}});return e.jsxs(Be,{collapsed:!0,style:{fontWeight:600,opacity:n.hidden?.33:void 0,backgroundColor:m.tableRowHeaderBackground},children:[o&&!o.preview&&o.type==="group"&&e.jsx(g,{innerRef:S,style:{position:"absolute",left:0,right:0,height:t?nn-1:(1+n.categories.length)*(nn-1)+1,zIndex:1e4},children:e.jsx(wt,{pos:b,offset:{top:1}})}),e.jsx(wt,{pos:B,offset:{top:1}}),e.jsxs(g,{innerRef:C,style:{flex:1,flexDirection:"row",opacity:v&&!o.preview?.3:1},children:[e.jsx(Zt,{innerRef:p,group:n,editing:s&&s.cell==="name"&&s.id===n.id,dragPreview:v&&o.preview,collapsed:t,onToggleCollapse:h,onEdit:r,onSave:l,onDelete:a,onShowNewCategory:w}),e.jsx(Ve,{component:i,args:{group:n}})]})]})}function go({cat:n,isLast:t,editingCell:s,MonthComponent:o,onEditName:i,onEditMonth:r,onSave:l,onDelete:a,onDragChange:d,onBudgetAction:c,onReorder:f,onShowActivity:h}){const{dragRef:w}=Ot({type:"income-category",onDragChange:d,item:n,canDrag:s===null}),{dropRef:v,dropPos:p}=bt({types:"income-category",id:n.id,onDrop:f});return e.jsxs(Be,{innerRef:v,collapsed:!0,style:{opacity:n.hidden?.5:void 0},children:[e.jsx(wt,{pos:p,offset:{top:1}}),e.jsx(Vt,{innerRef:w,category:n,isLast:t,editing:s&&s.cell==="name"&&s.id===n.id,onEditName:i,onSave:l,onDelete:a}),e.jsx(Ve,{component:o,editingMonth:s&&s.id===n.id&&s.cell,args:{category:n,onEdit:r,isLast:t,onShowActivity:h,onBudgetAction:c}})]})}function xo({group:n,editingCell:t,collapsed:s,MonthComponent:o,onEditName:i,onSave:r,onToggleCollapse:l,onShowNewCategory:a}){return e.jsxs(Be,{collapsed:!0,style:{fontWeight:600,backgroundColor:m.tableRowHeaderBackground},children:[e.jsx(Zt,{group:n,collapsed:s,editing:t&&t.cell==="name"&&t.id===n.id,onEdit:i,onSave:r,onToggleCollapse:l,onShowNewCategory:a}),e.jsx(Ve,{component:o,args:{group:n}})]})}function mo({MonthComponent:n,onShowNewGroup:t}){return e.jsxs(g,{style:{flexDirection:"row",flex:1},children:[e.jsx(g,{style:{width:200,alignItems:"flex-start",justifyContent:"flex-start"},children:e.jsx(K,{onClick:t,style:{fontSize:12,margin:10},children:"Add Group"})}),e.jsx(Ve,{component:n,style:{border:0,justifyContent:"flex-end"}})]})}const Hn=u.memo(({categoryGroups:n,editingCell:t,dataComponents:s,onBudgetAction:o,onShowActivity:i,onEditName:r,onEditMonth:l,onSaveCategory:a,onSaveGroup:d,onDeleteCategory:c,onDeleteGroup:f,onReorderCategory:h,onReorderGroup:w})=>{const[v=[],p]=ce("budget.collapsed"),[S]=ce("budget.showHiddenCategories");function b(x){p(x)}const[C,B]=u.useState(!1),[P,R]=u.useState(null),N=u.useMemo(()=>{const[x,A]=Ss(n);let y=Array.prototype.concat.apply([],x.map(j=>{if(j.hidden&&!S)return[];const k=j.categories.filter(Q=>S||!Q.hidden),F=[{type:"expense-group",value:{...j}}];return P===j.id&&F.push({type:"new-category"}),[...F,...(v.includes(j.id)?[]:k).map(Q=>({type:"expense-category",value:Q,group:j}))]}));return C&&y.push({type:"new-group"}),A&&(y=y.concat([{type:"income-separator"},{type:"income-group",value:A},P===A.id&&{type:"new-category"},...(v.includes(A.id)?[]:A.categories.filter(j=>S||!j.hidden)).map(j=>({type:"income-category",value:j}))].filter(j=>j))),y},[n,v,P,C,S]),[T,I]=u.useState(null),[D,E]=u.useState(null);function W(x){const{state:A}=x;A==="start-preview"?I({type:x.type,item:x.item,preview:!0}):A==="start"?T&&(I({...T,preview:!1}),E(v)):A==="hover"?I({...T,hoveredId:x.id,hoveredPos:x.pos}):A==="end"&&(I(null),b(D||[]))}function O(x){v.includes(x)?b(v.filter(A=>A!==x)):b([...v,x])}function z(){B(!0)}function Y(){B(!1)}function J(x){d?.(x),x.id==="new"&&Y()}function H(x){b(v.filter(A=>A!==x)),R(x)}function ee(){R(null)}function L(x){a?.(x),x.id==="new"&&ee()}return e.jsx(g,{style:{marginBottom:10,backgroundColor:m.tableBackground,overflow:"hidden",boxShadow:G.cardShadow,borderRadius:"0 0 4px 4px",flex:1},children:N.map((x,A)=>{let y;switch(x.type){case"new-group":y=e.jsx(Be,{style:{backgroundColor:m.tableRowHeaderBackground},children:e.jsx(Zt,{group:{id:"new",name:""},editing:!0,onSave:J,onHideNewGroup:Y,onEdit:r})});break;case"new-category":y=e.jsx(Be,{children:e.jsx(Vt,{category:{name:"",cat_group:P,is_income:P===n.find(k=>k.is_income).id,id:"new"},editing:!0,onSave:L,onHideNewCategory:ee,onEditName:r})});break;case"expense-group":y=e.jsx(fo,{group:x.value,editingCell:t,collapsed:v.includes(x.value.id),MonthComponent:s.ExpenseGroupComponent,dragState:T,onEditName:r,onSave:J,onDelete:f,onDragChange:W,onReorderGroup:w,onReorderCategory:h,onToggleCollapse:O,onShowNewCategory:H});break;case"expense-category":y=e.jsx(po,{cat:x.value,categoryGroup:x.group,editingCell:t,MonthComponent:s.ExpenseCategoryComponent,dragState:T,onEditName:r,onEditMonth:l,onSave:L,onDelete:c,onDragChange:W,onReorder:h,onBudgetAction:o,onShowActivity:i});break;case"income-separator":y=e.jsx(g,{style:{height:G.incomeHeaderHeight,backgroundColor:m.tableBackground},children:e.jsx(mo,{MonthComponent:s.IncomeHeaderComponent,onShowNewGroup:z})});break;case"income-group":y=e.jsx(xo,{group:x.value,editingCell:t,MonthComponent:s.IncomeGroupComponent,collapsed:v.includes(x.value.id),onEditName:r,onSave:J,onToggleCollapse:O,onShowNewCategory:H});break;case"income-category":y=e.jsx(go,{cat:x.value,editingCell:t,isLast:A===N.length-1,MonthComponent:s.IncomeCategoryComponent,onEditName:r,onEditMonth:l,onSave:L,onDelete:c,onDragChange:W,onReorder:h,onBudgetAction:o,onShowActivity:i});break;default:throw new Error("Unknown item type: "+x.type)}const j=A===0?"first":A===N.length-1?"last":null;return e.jsx(Cs.Provider,{value:j,children:e.jsx(g,{style:!T&&{":hover":{backgroundColor:m.tableBackground}},children:y})},x.value?x.value.id:x.type==="income-separator"?"separator":A)})})});Hn.displayName="BudgetCategories";function yo({SummaryComponent:n}){const{months:t}=u.useContext(yn),[s,o]=u.useState(0),[i,r]=Ts(()=>({x:0,config:{mass:3,tension:600,friction:80}})),l=mn(u.useCallback(f=>{o(f.width)},[])),a=u.useRef(t[0]),d=[...t];d.unshift(Xe(t[0],1)),d.push(mt(t[t.length-1],1));const c=s/t.length;return u.useLayoutEffect(()=>{const f=a.current,h=f>t[0],w=c;let v=h?-w*2:0;f!==d[0]&&f!==d[2]&&(v=-w);const p=-w;r.start({from:{x:v},x:p})},[t[0]]),u.useLayoutEffect(()=>{a.current=t[0]},[t[0]]),u.useLayoutEffect(()=>{r.start({from:{x:-c},to:{x:-c}})},[c]),e.jsx("div",{className:`${Ht([{flex:1,overflow:"hidden"},t.length===1&&{marginLeft:-4,marginRight:-4}])}`,ref:l,children:e.jsx(ks.div,{className:"view",style:{flexDirection:"row",width:s,willChange:"transform",transform:i.x.to(f=>`translateX(${f}px)`)},children:d.map(f=>e.jsx(g,{style:{flex:`0 0 ${c}px`,paddingLeft:4,paddingRight:4},children:e.jsx(n,{month:f})},f))})})}const bo=u.memo(function({MonthComponent:t,toggleHiddenCategories:s,expandAllCategories:o,collapseAllCategories:i}){const[r,l]=u.useState(!1),a=u.useRef(null);return e.jsxs(g,{"data-testid":"budget-totals",style:{backgroundColor:m.tableBackground,flexDirection:"row",flexShrink:0,boxShadow:G.cardShadow,marginLeft:5,marginRight:5+Nt(),borderRadius:"4px 4px 0 0",borderBottom:"1px solid "+m.tableBorder},children:[e.jsxs(g,{style:{width:200,color:m.pageTextLight,justifyContent:"center",paddingLeft:15,paddingRight:5,display:"flex",flexDirection:"row",alignItems:"center",userSelect:"none",WebkitUserSelect:"none"},children:[e.jsx(g,{style:{flexGrow:"1"},children:"Category"}),e.jsx(K,{ref:a,type:"bare","aria-label":"Menu",onClick:()=>{l(!0)},style:{color:"currentColor",padding:3},children:e.jsx(Wt,{width:15,height:15,style:{color:m.pageTextLight}})}),e.jsx(ie,{triggerRef:a,isOpen:r,onOpenChange:()=>l(!1),style:{width:200},children:e.jsx(je,{onMenuSelect:d=>{d==="toggle-visibility"?s():d==="expandAllCategories"?o():d==="collapseAllCategories"&&i(),l(!1)},items:[{name:"toggle-visibility",text:"Toggle hidden categories"},{name:"expandAllCategories",text:"Expand all"},{name:"collapseAllCategories",text:"Collapse all"}]})})]}),e.jsx(Ve,{component:t})]})});function Wn(n){const{type:t,prewarmStartMonth:s,startMonth:o,numMonths:i,monthBounds:r,dataComponents:l,onSaveCategory:a,onDeleteCategory:d,onSaveGroup:c,onDeleteGroup:f,onReorderCategory:h,onReorderGroup:w,onShowActivity:v,onBudgetAction:p}=n,{grouped:S}=st(),[b=[],C]=ce("budget.collapsed"),[B,P]=ce("budget.showHiddenCategories"),[R,N]=u.useState(null),T=(L,x)=>{N(L?{id:L,cell:x}:null)},I=L=>{N(L?{id:L,cell:"name"}:null)},D=(L,x,A)=>{if(!!S.find(j=>j.id===A)){const{targetId:j}=Bs(S,x,A),k=S.find(F=>F.id===j);if(k){const{categories:F}=k;h({id:L,groupId:k.id,targetId:F.length===0||x==="top"?null:F[0].id})}}else{let j;for(const k of S)if(k.categories.find(F=>F.id===A)){j=k;break}h({id:L,groupId:j.id,...an(j.categories,x,A)})}},E=(L,x,A)=>{w({id:L,...an(S,x,A)})},W=L=>{const x=S.reduce((A,y)=>b.includes(y.id)?A.concat({id:y.id,isGroup:!0}):A.concat([{id:y.id,isGroup:!0},...y.categories]),[]);if(R){let y=x.findIndex(j=>j.id===R.id)+L;for(;y>=0&&y<x.length;){const j=x[y];if(j.isGroup){y+=L;continue}else if(t==="report"||!j.is_income){T(j.id,R.cell);return}else break}}},O=L=>{if(!R)return null;(L.key==="Enter"||L.key==="Tab")&&(L.preventDefault(),W(L.shiftKey?-1:1))},z=L=>{C(L)},Y=()=>{P(!B)},J=()=>{Y()},H=()=>{z([])},ee=()=>{z(S.map(L=>L.id))};return e.jsxs(g,{"data-testid":"budget-table",style:{flex:1,...G.lightScrollbar&&{"& ::-webkit-scrollbar":{backgroundColor:"transparent"},"& ::-webkit-scrollbar-thumb:vertical":{backgroundColor:m.tableHeaderBackground}}},children:[e.jsxs(g,{style:{flexDirection:"row",overflow:"hidden",flexShrink:0,paddingLeft:5,paddingRight:5+Nt()},children:[e.jsx(g,{style:{width:200}}),e.jsx(sn,{startMonth:s,numMonths:i,monthBounds:r,type:t,children:e.jsx(yo,{SummaryComponent:l.SummaryComponent})})]}),e.jsxs(sn,{startMonth:o,numMonths:i,monthBounds:r,type:t,children:[e.jsx(bo,{MonthComponent:l.BudgetTotalsComponent,toggleHiddenCategories:J,expandAllCategories:H,collapseAllCategories:ee}),e.jsx(g,{style:{overflowY:"scroll",overflowAnchor:"none",flex:1,paddingLeft:5,paddingRight:5},children:e.jsx(g,{style:{flexShrink:0},onKeyDown:O,children:e.jsx(Hn,{categoryGroups:S,editingCell:R,dataComponents:l,onEditMonth:T,onEditName:I,onSaveCategory:a,onSaveGroup:c,onDeleteCategory:d,onDeleteGroup:f,onReorderCategory:D,onReorderGroup:E,onBudgetAction:p,onShowActivity:v})})})]})]})}Wn.displayName="BudgetTable";function wo(n){const t=n-200;return t<500?1:t<750?2:t<1e3?3:t<1250?4:t<1500?5:6}const $n=({type:n,width:t,height:s,prewarmStartMonth:o,startMonth:i,maxMonths:r=3,monthBounds:l,onMonthSelect:a,...d})=>{const{setDisplayMax:c}=Rs(),f=wo(t),h=Math.min(f,r),w=200+500*h;u.useEffect(()=>{c(f)},[f]);function v(S){const b=l.start,C=Xe(l.end,h-1);return S<b?b:S>C?C:S}function p(S){a(v(S),h)}return re("left",()=>{p(wn(i))},{preventDefault:!0,scopes:["app"]},[p,i]),re("right",()=>{p(As(i))},{preventDefault:!0,scopes:["app"]},[p,i]),re("0",()=>{p(Xe(et(),n==="rollover"?Math.floor((h-1)/2):h===2?1:Math.max(h-2,0)))},{preventDefault:!0,scopes:["app"]},[p,i,h]),e.jsx(g,{style:{width:t,height:s,alignItems:"center",opacity:t<=0||s<=0?0:1},children:e.jsxs(g,{style:{width:"100%",maxWidth:w},children:[e.jsx(On,{startMonth:o,numMonths:h,monthBounds:l,onMonthSelect:p}),e.jsx(Wn,{prewarmStartMonth:o,startMonth:i,numMonths:h,monthBounds:l,...d})]})})};$n.displayName="DynamicBudgetTableInner";const _t=n=>e.jsx(Ms,{children:({width:t,height:s})=>e.jsx($n,{width:t,height:s,...n})});_t.displayName="DynamicBudgetTable";const Gn=u.createContext(null);function jo({summaryCollapsed:n,onBudgetAction:t,onToggleSummaryCollapse:s,children:o}){const i=et();return e.jsx(Gn.Provider,{value:{currentMonth:i,summaryCollapsed:n,onBudgetAction:t,onToggleSummaryCollapse:s},children:o})}function vo(){return u.useContext(Gn)}function Un({month:n}){const{currentMonth:t,summaryCollapsed:s,onBudgetAction:o,onToggleSummaryCollapse:i}=vo(),[r,l]=u.useState(!1),a=u.useRef(null);function d(){l(!0)}function c(){l(!1)}const f=s?Fn:Nn;return e.jsx(g,{style:{backgroundColor:m.tableBackground,boxShadow:G.cardShadow,borderRadius:6,marginLeft:0,marginRight:0,marginTop:5,flex:1,cursor:"default",marginBottom:5,overflow:"hidden","& .hover-visible":{opacity:0,transition:"opacity .25s"},"&:hover .hover-visible":{opacity:1}},children:e.jsxs(ze.Provider,{value:tt(n),children:[e.jsxs(g,{style:{padding:"0 13px",...s?{margin:"10px 0"}:{marginTop:16}},children:[e.jsx(g,{style:{position:"absolute",left:10,top:0},children:e.jsx(K,{type:"bare","aria-label":`${s?"Expand":"Collapse"} month summary`,className:"hover-visible",onClick:i,children:e.jsx(f,{width:13,height:13,style:{color:m.pageTextSubdued,margin:1}})})}),e.jsx("div",{className:`${Ht([{textAlign:"center",marginTop:3,fontSize:18,fontWeight:500,textDecorationSkip:"ink"}])}`,children:yt(n,"MMMM")}),e.jsxs(g,{style:{position:"absolute",right:10,top:0,flexDirection:"row",alignItems:"center"},children:[e.jsx(g,{children:e.jsx(lt,{id:`budget-${n}`,width:15,height:15,tooltipPosition:"bottom right",defaultColor:m.pageTextLight})}),e.jsxs(g,{style:{userSelect:"none"},children:[e.jsx(K,{ref:a,type:"bare","aria-label":"Menu",onClick:d,children:e.jsx(Wt,{width:15,height:15,style:{color:m.pageTextLight}})}),e.jsx(ie,{triggerRef:a,isOpen:r,onOpenChange:c,children:e.jsx(Is,{onCopyLastMonthBudget:()=>{o(n,"copy-last"),c()},onSetBudgetsToZero:()=>{o(n,"set-zero"),c()},onSetMonthsAverage:h=>{o(n,`set-${h}-avg`),c()},onCheckTemplates:()=>{o(n,"check-templates"),c()},onApplyBudgetTemplates:()=>{o(n,"apply-goal-template"),c()},onOverwriteWithBudgetTemplates:()=>{o(n,"overwrite-goal-template"),c()}})})]})]})]}),!s&&e.jsxs(Je,{spacing:2,style:{alignSelf:"center",backgroundColor:m.tableRowHeaderBackground,borderRadius:4,padding:"10px 15px",marginTop:13},children:[e.jsx(Ps,{}),e.jsx(Ds,{})]}),s?e.jsx(g,{style:{alignItems:"center",padding:"10px 20px",justifyContent:"space-between",backgroundColor:m.tableRowHeaderBackground,borderTop:"1px solid "+m.tableBorder},children:e.jsx(on,{projected:n>=t})}):e.jsx(on,{projected:n>=t,style:{marginTop:13,marginBottom:20}})]})})}const Ye={flex:1,padding:"0 5px",textAlign:"right"},zn=u.memo(function(){const t=at();return e.jsxs(g,{style:{flex:1,flexDirection:"row",marginRight:G.monthRightPadding,paddingTop:10,paddingBottom:10},children:[e.jsxs(g,{style:Ye,children:[e.jsx(X,{style:{color:m.pageTextLight},children:"Budgeted"}),e.jsx(ve,{binding:ue.totalBudgetedExpense,type:"financial",style:{color:m.pageTextLight,fontWeight:600},formatter:s=>t(parseFloat(s||"0"),"financial")})]}),e.jsxs(g,{style:Ye,children:[e.jsx(X,{style:{color:m.pageTextLight},children:"Spent"}),e.jsx(ve,{binding:ue.totalSpent,type:"financial",style:{color:m.pageTextLight,fontWeight:600}})]}),e.jsxs(g,{style:Ye,children:[e.jsx(X,{style:{color:m.pageTextLight},children:"Balance"}),e.jsx(ve,{binding:ue.totalLeftover,type:"financial",style:{color:m.pageTextLight,fontWeight:600}})]})]})});function Qn(){return e.jsxs(g,{style:{flexDirection:"row",marginRight:G.monthRightPadding,paddingBottom:5},children:[e.jsx(g,{style:Ye,children:e.jsx(X,{style:{color:m.pageTextLight},children:"Budgeted"})}),e.jsx(g,{style:Ye,children:e.jsx(X,{style:{color:m.pageTextLight},children:"Received"})})]})}const qt=u.memo(function({group:t}){const{id:s}=t;return e.jsxs(g,{style:{flex:1,flexDirection:"row"},children:[e.jsx(ke,{name:"budgeted",width:"flex",textAlign:"right",style:{fontWeight:600,...G.tnum},valueProps:{binding:ue.groupBudgeted(s),type:"financial"}}),e.jsx(ke,{name:"spent",width:"flex",textAlign:"right",style:{fontWeight:600,...G.tnum},valueProps:{binding:ue.groupSumAmount(s),type:"financial"}}),!t.is_income&&e.jsx(ke,{name:"balance",width:"flex",textAlign:"right",style:{fontWeight:600,paddingRight:G.monthRightPadding,...G.tnum},valueProps:{binding:ue.groupBalance(s),type:"financial",privacyFilter:{style:{paddingRight:G.monthRightPadding}}}})]})}),Kt=u.memo(function({month:t,category:s,editing:o,onEdit:i,onBudgetAction:r,onShowActivity:l}){const[a,d]=u.useState(!1),[c,f]=u.useState(!1),h=u.useRef(null),[w,v]=u.useState(!1),p=u.useRef(null),S=(...b)=>{r(...b),v(!1),d(!1)};return e.jsxs(g,{style:{flex:1,flexDirection:"row","& .hover-visible":{opacity:0,transition:"opacity .25s"},"&:hover .hover-visible":{opacity:1}},children:[e.jsxs(g,{style:{flex:1,flexDirection:"row"},onMouseOverCapture:()=>f(!0),onMouseLeave:()=>{f(!1)},children:[!o&&(c||a)&&e.jsxs(g,{style:{flexShrink:0,paddingLeft:3,justifyContent:"center",borderTopWidth:1,borderBottomWidth:1,borderColor:m.tableBorder},children:[e.jsx(K,{ref:h,type:"bare",onClick:b=>{b.stopPropagation(),d(!0)},style:{padding:3},children:e.jsx(nt,{width:14,height:14,className:"hover-visible",style:a&&{opacity:1}})}),e.jsx(ie,{triggerRef:h,isOpen:a,onOpenChange:()=>d(!1),placement:"bottom start",children:e.jsx(Es,{onCopyLastMonthAverage:()=>{S(t,"copy-single-last",{category:s.id})},onSetMonthsAverage:b=>{b!==3&&b!==6&&b!==12||S(t,`set-single-${b}-avg`,{category:s.id})},onApplyBudgetTemplate:()=>{S(t,"apply-single-category-template",{category:s.id})}})})]}),e.jsx(ke,{name:"budget",exposed:o,focused:o,width:"flex",onExpose:()=>i(s.id,t),style:{...o&&{zIndex:100},...G.tnum},textAlign:"right",valueStyle:{cursor:"default",margin:1,padding:"0 4px",borderRadius:4,":hover":{boxShadow:"inset 0 0 0 1px "+m.mobileAccountShadow,backgroundColor:m.tableBackground}},valueProps:{binding:ue.catBudgeted(s.id),type:"financial",getValueStyle:jt,formatExpr:b=>De(b),unformatExpr:b=>ot(Ue(b,0))},inputProps:{onBlur:()=>{i(null)},style:{backgroundColor:m.tableBackground}},onSave:b=>{r(t,"budget-amount",{category:s.id,amount:b})}})]}),e.jsx(We,{name:"spent",width:"flex",style:{textAlign:"right"},children:e.jsx("span",{"data-testid":"category-month-spent",onClick:()=>l(s.id,t),children:e.jsx(ve,{binding:ue.catSumAmount(s.id),type:"financial",getStyle:jt,style:{cursor:"pointer",":hover":{textDecoration:"underline"}}})})}),!s.is_income&&e.jsxs(We,{name:"balance",width:"flex",style:{paddingRight:G.monthRightPadding,textAlign:"right"},children:[e.jsx("span",{ref:p,...s.is_income?{}:{onClick:()=>v(!0)},children:e.jsx(jn,{disabled:s.is_income,carryover:ue.catCarryover(s.id),balance:ue.catBalance(s.id),goal:ue.catGoal(s.id),budgeted:ue.catBudgeted(s.id),longGoal:ue.catLongGoal(s.id),style:{":hover":{textDecoration:"underline"}}})}),e.jsx(ie,{triggerRef:p,isOpen:w,onOpenChange:()=>v(!1),placement:"bottom end",children:e.jsx(Ls,{categoryId:s.id,onCarryover:b=>{S(t,"carryover",{category:s.id,flag:b})}})})]})]})}),Vn=qt,Zn=Kt,qn=qt,Kn=Kt,So=Object.freeze(Object.defineProperty({__proto__:null,BudgetSummary:Un,BudgetTotalsMonth:zn,CategoryMonth:Kt,ExpenseCategoryMonth:Zn,ExpenseGroupMonth:Vn,GroupMonth:qt,IncomeCategoryMonth:Kn,IncomeGroupMonth:qn,IncomeHeaderMonth:Qn},Symbol.toStringTag,{value:"Module"}));function Yn({showToBeBudgeted:n=!0,onSubmit:t,onClose:s}){const{grouped:o}=st();let i=o.filter(d=>!d.is_income);i=n?vn(i):i;const[r,l]=u.useState(null);function a(){r&&t(r),s()}return e.jsxs(g,{style:{padding:10},children:[e.jsx(g,{style:{marginBottom:5},children:"Cover from category:"}),e.jsx(it,{children:d=>e.jsx($t,{categoryGroups:i,value:i.find(c=>c.id===r),openOnFocus:!0,onSelect:c=>l(c||null),inputProps:{inputRef:d,onEnter:c=>!c.defaultPrevented&&a(),placeholder:"(none)"},showHiddenCategories:!1})}),e.jsx(g,{style:{alignItems:"flex-end",marginTop:10},children:e.jsx(K,{type:"primary",style:{fontSize:12,paddingTop:3},onClick:a,children:"Transfer"})})]})}function Xn({initialAmount:n=0,showToBeBudgeted:t,onSubmit:s,onClose:o}){const{grouped:i}=st();let r=i.filter(w=>!w.is_income);t&&(r=vn(r));const l=De(Math.max(n,0)),[a,d]=u.useState(null),[c,f]=u.useState(null),h=(w,v)=>{const p=Ue(w||"");p&&v&&s?.(ot(p),v),o()};return e.jsxs(g,{style:{padding:10},children:[e.jsx(g,{style:{marginBottom:5},children:"Transfer this amount:"}),e.jsx(g,{children:e.jsx(it,{children:e.jsx(rt,{defaultValue:l,onUpdate:w=>d(w),onEnter:()=>h(a,c)})})}),e.jsx(g,{style:{margin:"10px 0 5px 0"},children:"To:"}),e.jsx($t,{categoryGroups:r,value:r.find(w=>w.id===c),openOnFocus:!0,onSelect:w=>f(w||null),inputProps:{onEnter:w=>!w.defaultPrevented&&h(a,c),placeholder:"(none)"},showHiddenCategories:!0}),e.jsx(g,{style:{alignItems:"flex-end",marginTop:10},children:e.jsx(K,{type:"primary",style:{fontSize:12,paddingTop:3,paddingBottom:3},onClick:()=>h(a,c),children:"Transfer"})})]})}function Co({categoryId:n,month:t,onBudgetAction:s,onClose:o=()=>{}}){const i=Ee(ae.catBalance(n)),[r,l]=u.useState("menu");return e.jsxs(e.Fragment,{children:[r==="menu"&&e.jsx(_s,{categoryId:n,onCarryover:a=>{s(t,"carryover",{category:n,flag:a}),o()},onTransfer:()=>l("transfer"),onCover:()=>l("cover")}),r==="transfer"&&e.jsx(Xn,{initialAmount:i,showToBeBudgeted:!0,onClose:o,onSubmit:(a,d)=>{s(t,"transfer-category",{amount:a,from:n,to:d})}}),r==="cover"&&e.jsx(Yn,{onClose:o,onSubmit:a=>{s(t,"cover-overspending",{to:n,from:a})}})]})}const Jn=u.createContext({summaryCollapsed:!1,onBudgetAction:()=>{throw new Error("Unitialised context method called: onBudgetAction")},onToggleSummaryCollapse:()=>{throw new Error("Unitialised context method called: onToggleSummaryCollapse")},currentMonth:"unknown"});function To({summaryCollapsed:n,onBudgetAction:t,onToggleSummaryCollapse:s,children:o}){const i=et();return e.jsx(Jn.Provider,{value:{currentMonth:i,summaryCollapsed:n,onBudgetAction:t,onToggleSummaryCollapse:s},children:o})}function ko(){return u.useContext(Jn)}function Bo({onSubmit:n,onClose:t}){const s=Sn(),o=u.useContext(ze),[i,r]=u.useState(null);u.useEffect(()=>{(async()=>{const a=await s.get(o,"to-budget");r(De(Math.max(a.value,0)))})()},[]);function l(a){const d=Ue(a);d&&n(ot(d)),t()}return i===null?null:e.jsxs(g,{style:{padding:10},children:[e.jsx(g,{style:{marginBottom:5},children:"Hold this amount:"}),e.jsx(g,{children:e.jsx(it,{children:e.jsx(rt,{value:i,onChange:a=>r(a.target.value),onEnter:()=>l(i)})})}),e.jsx(g,{style:{alignItems:"flex-end",marginTop:10},children:e.jsx(K,{type:"primary",style:{fontSize:12,paddingTop:3,paddingBottom:3},onClick:()=>l(i),children:"Hold"})})]})}function gn({month:n,prevMonthName:t,onBudgetAction:s,style:o,amountStyle:i,isCollapsed:r=!1}){const[l,a]=u.useState(null),d=u.useRef(null),c=Ee({name:ae.toBudget,value:0}),f=parseInt(c),h=!!l;return e.jsxs(e.Fragment,{children:[e.jsx(g,{ref:d,children:e.jsx(Fs,{onClick:()=>a("actions"),prevMonthName:t,style:o,amountStyle:i,isTotalsListTooltipDisabled:!r||h})}),e.jsxs(ie,{triggerRef:d,placement:"bottom",isOpen:h,onOpenChange:()=>a(null),style:{width:200},children:[l==="actions"&&e.jsx(Ns,{onTransfer:()=>a("transfer"),onCover:()=>a("cover"),onHoldBuffer:()=>a("buffer"),onResetHoldBuffer:()=>{s(n,"reset-hold"),a(null)}}),l==="buffer"&&e.jsx(Bo,{onClose:()=>a(null),onSubmit:w=>{s(n,"hold",{amount:w})}}),l==="transfer"&&e.jsx(Xn,{initialAmount:f,onClose:()=>a(null),onSubmit:(w,v)=>{s(n,"transfer-available",{amount:w,category:v})}}),l==="cover"&&e.jsx(Yn,{showToBeBudgeted:!1,onClose:()=>a(null),onSubmit:w=>{s(n,"cover-overbudgeted",{category:w})}})]})]})}function es({month:n}){const{currentMonth:t,summaryCollapsed:s,onBudgetAction:o,onToggleSummaryCollapse:i}=ko(),[r,l]=u.useState(!1),a=u.useRef(null);function d(){l(!0)}function c(){l(!1)}const f=yt(wn(n),"MMM"),h=s?Fn:Nn;return e.jsx(g,{"data-testid":"budget-summary",style:{backgroundColor:m.tableBackground,boxShadow:G.cardShadow,borderRadius:6,marginLeft:0,marginRight:0,marginTop:5,flex:1,cursor:"default",marginBottom:5,overflow:"hidden","& .hover-visible":{opacity:0,transition:"opacity .25s"},"&:hover .hover-visible":{opacity:1}},children:e.jsxs(ze.Provider,{value:tt(n),children:[e.jsxs(g,{style:{padding:"0 13px",...s?{margin:"10px 0"}:{marginTop:16}},children:[e.jsx(g,{style:{position:"absolute",left:10,top:0},children:e.jsx(K,{type:"bare","aria-label":`${s?"Expand":"Collapse"} month summary`,className:"hover-visible",onClick:i,children:e.jsx(h,{width:13,height:13,style:{color:m.tableTextLight,margin:1}})})}),e.jsx("div",{className:`${Ht([{textAlign:"center",marginTop:3,fontSize:18,fontWeight:500,textDecorationSkip:"ink"},t===n&&{fontWeight:"bold"}])}`,children:yt(n,"MMMM")}),e.jsxs(g,{style:{position:"absolute",right:10,top:0,flexDirection:"row",alignItems:"center"},children:[e.jsx(g,{children:e.jsx(lt,{id:`budget-${n}`,width:15,height:15,tooltipPosition:"bottom right",defaultColor:m.tableTextLight})}),e.jsxs(g,{style:{userSelect:"none",marginLeft:2},children:[e.jsx(K,{ref:a,type:"bare","aria-label":"Menu",onClick:d,children:e.jsx(Wt,{width:15,height:15,style:{color:m.pageTextLight}})}),e.jsx(ie,{triggerRef:a,isOpen:r,onOpenChange:c,children:e.jsx(Os,{onCopyLastMonthBudget:()=>{o(n,"copy-last"),c()},onSetBudgetsToZero:()=>{o(n,"set-zero"),c()},onSetMonthsAverage:w=>{o(n,`set-${w}-avg`),c()},onCheckTemplates:()=>{o(n,"check-templates"),c()},onApplyBudgetTemplates:()=>{o(n,"apply-goal-template"),c()},onOverwriteWithBudgetTemplates:()=>{o(n,"overwrite-goal-template"),c()},onEndOfMonthCleanup:()=>{o(n,"cleanup-goal-template"),c()}})})]})]})]}),s?e.jsx(g,{style:{alignItems:"center",padding:"10px 20px",justifyContent:"space-between",backgroundColor:m.tableBackground,borderTop:"1px solid "+m.tableBorder},children:e.jsx(gn,{prevMonthName:f,month:n,onBudgetAction:o,isCollapsed:!0})}):e.jsxs(e.Fragment,{children:[e.jsx(Hs,{prevMonthName:f,style:{padding:"5px 0",marginTop:17,backgroundColor:m.tableRowHeaderBackground,borderTopWidth:1,borderBottomWidth:1,borderColor:m.tableBorder}}),e.jsx(g,{style:{margin:"23px 0"},children:e.jsx(gn,{prevMonthName:f,month:n,onBudgetAction:o})})]})]})})}const Rt={flex:1,padding:"0 5px",textAlign:"right"},ts=u.memo(function(){const t=at();return e.jsxs(g,{style:{flex:1,flexDirection:"row",marginRight:G.monthRightPadding,paddingTop:10,paddingBottom:10},children:[e.jsxs(g,{style:Rt,children:[e.jsx(X,{style:{color:m.tableHeaderText},children:"Budgeted"}),e.jsx(ve,{binding:ae.totalBudgeted,type:"financial",style:{color:m.tableHeaderText,fontWeight:600},formatter:s=>t(-parseFloat(s||"0"),"financial")})]}),e.jsxs(g,{style:Rt,children:[e.jsx(X,{style:{color:m.tableHeaderText},children:"Spent"}),e.jsx(ve,{binding:ae.totalSpent,type:"financial",style:{color:m.tableHeaderText,fontWeight:600}})]}),e.jsxs(g,{style:Rt,children:[e.jsx(X,{style:{color:m.tableHeaderText},children:"Balance"}),e.jsx(ve,{binding:ae.totalBalance,type:"financial",style:{color:m.tableHeaderText,fontWeight:600}})]})]})});function ns(){return e.jsx(Be,{style:{color:m.tableHeaderText,alignItems:"center",paddingRight:10},children:e.jsx(g,{style:{flex:1,textAlign:"right"},children:"Received"})})}const ss=u.memo(function({group:t}){const{id:s}=t;return e.jsxs(g,{style:{flex:1,flexDirection:"row"},children:[e.jsx(ke,{name:"budgeted",width:"flex",textAlign:"right",style:{fontWeight:600,...G.tnum},valueProps:{binding:ae.groupBudgeted(s),type:"financial"}}),e.jsx(ke,{name:"spent",width:"flex",textAlign:"right",style:{fontWeight:600,...G.tnum},valueProps:{binding:ae.groupSumAmount(s),type:"financial"}}),e.jsx(ke,{name:"balance",width:"flex",textAlign:"right",style:{fontWeight:600,paddingRight:G.monthRightPadding,...G.tnum},valueProps:{binding:ae.groupBalance(s),type:"financial",privacyFilter:{style:{paddingRight:G.monthRightPadding}}}})]})}),as=u.memo(function({month:t,category:s,editing:o,onEdit:i,onBudgetAction:r,onShowActivity:l}){const a=u.useRef(null),d=u.useRef(null),[c,f]=u.useState(!1),[h,w]=u.useState(!1),[v,p]=u.useState(!1),S=(...b)=>{r(...b),f(!1)};return e.jsxs(g,{style:{flex:1,flexDirection:"row","& .hover-visible":{opacity:0,transition:"opacity .25s"},"&:hover .hover-visible":{opacity:1}},children:[e.jsxs(g,{style:{flex:1,flexDirection:"row"},onMouseOverCapture:()=>p(!0),onMouseLeave:()=>{p(!1)},children:[!o&&(v||c)?e.jsxs(g,{style:{flexShrink:1,paddingLeft:3,justifyContent:"center",borderTopWidth:1,borderBottomWidth:1,borderColor:m.tableBorder},children:[e.jsx(K,{ref:a,type:"bare",onClick:b=>{b.stopPropagation(),f(!0)},style:{padding:3},children:e.jsx(nt,{width:14,height:14,className:"hover-visible",style:c?{opacity:1}:{}})}),e.jsx(ie,{triggerRef:a,placement:"bottom start",isOpen:c,onOpenChange:()=>f(!1),style:{width:200},children:e.jsx(Ws,{onCopyLastMonthAverage:()=>{S(t,"copy-single-last",{category:s.id})},onSetMonthsAverage:b=>{b!==3&&b!==6&&b!==12||S(t,`set-single-${b}-avg`,{category:s.id})},onApplyBudgetTemplate:()=>{S(t,"apply-single-category-template",{category:s.id})}})})]}):null,e.jsx(ke,{name:"budget",exposed:o,focused:o,width:"flex",onExpose:()=>i(s.id,t),style:{...o&&{zIndex:100},...G.tnum},textAlign:"right",valueStyle:{cursor:"default",margin:1,padding:"0 4px",borderRadius:4,":hover":{boxShadow:"inset 0 0 0 1px "+m.mobileAccountShadow,backgroundColor:m.tableBackground}},valueProps:{binding:ae.catBudgeted(s.id),type:"financial",getValueStyle:jt,formatExpr:b=>De(b),unformatExpr:b=>ot(Ue(b,0))},inputProps:{onBlur:()=>{i(null)},style:{backgroundColor:m.tableBackground}},onSave:b=>{r(t,"budget-amount",{category:s.id,amount:b})}})]}),e.jsx(We,{name:"spent",width:"flex",style:{textAlign:"right"},children:e.jsx("span",{"data-testid":"category-month-spent",onClick:()=>l(s.id,t),children:e.jsx(ve,{binding:ae.catSumAmount(s.id),type:"financial",getStyle:jt,style:{cursor:"pointer",":hover":{textDecoration:"underline"}}})})}),e.jsxs(We,{name:"balance",width:"flex",style:{paddingRight:G.monthRightPadding,textAlign:"right"},children:[e.jsx("span",{ref:d,onClick:()=>w(!0),children:e.jsx(jn,{carryover:ae.catCarryover(s.id),balance:ae.catBalance(s.id),goal:ae.catGoal(s.id),budgeted:ae.catBudgeted(s.id),longGoal:ae.catLongGoal(s.id),style:{":hover":{textDecoration:"underline"}}})}),e.jsx(ie,{triggerRef:d,placement:"bottom end",isOpen:h,onOpenChange:()=>w(!1),style:{width:200},children:e.jsx(Co,{categoryId:s.id,month:t,onBudgetAction:r,onClose:()=>w(!1)})})]})]})});function os(){return e.jsx(g,{style:{flex:1},children:e.jsx(ke,{name:"received",width:"flex",textAlign:"right",style:{fontWeight:600,paddingRight:G.monthRightPadding,...G.tnum},valueProps:{binding:ae.groupIncomeReceived,type:"financial",privacyFilter:{style:{paddingRight:G.monthRightPadding}}}})})}function is({category:n,isLast:t,month:s,onShowActivity:o}){return e.jsx(g,{style:{flex:1},children:e.jsx(We,{name:"received",width:"flex",style:{paddingRight:G.monthRightPadding,textAlign:"right",...t&&{borderBottomWidth:0}},children:e.jsx("span",{onClick:()=>o(n.id,s),children:e.jsx(ve,{binding:ae.catSumAmount(n.id),type:"financial",style:{cursor:"pointer",":hover":{textDecoration:"underline"}}})})})})}const Mo=Object.freeze(Object.defineProperty({__proto__:null,BudgetSummary:es,BudgetTotalsMonth:ts,ExpenseCategoryMonth:as,ExpenseGroupMonth:ss,IncomeCategoryMonth:is,IncomeGroupMonth:os,IncomeHeaderMonth:ns},Symbol.toStringTag,{value:"Module"}));function Ro(n){const t=et(),s=Sn(),o=Qe(),i=Cn(),[r,l]=ce("budget.summaryCollapsed"),[a,d]=ce("budget.startMonth"),c=a||t,[f,h]=u.useState({start:c,end:c}),[w]=ce("budgetType"),v=w||"rollover",[p]=$s("maxMonths"),S=p||1,[b,C]=u.useState(!1),{grouped:B}=st();function P(){o(Gs())}u.useEffect(()=>{async function x(){P();const{start:y,end:j}=await V("get-budget-bounds");h({start:y,end:j}),await Us(v,s,{start:y,end:j},c),C(!0)}x();const A=[Dt("sync-event",({type:y,tables:j})=>{y==="success"&&(j.includes("categories")||j.includes("category_mapping")||j.includes("category_groups"))&&P()}),Dt("undo-event",({tables:y})=>{y.includes("categories")&&P()})];return()=>{A.forEach(y=>y())}},[]),u.useEffect(()=>{V("get-budget-bounds").then(({start:x,end:A})=>{(f.start!==x||f.end!==A)&&h({start:x,end:A})})},[n.accountId]);const R=async(x,A)=>{d(x);const y=x;x<c?await rn(v,s,Xe(x,1)):x>c&&await rn(v,s,mt(x,A)),y===x&&d(x)},N=x=>{o(Xs({type:"error",message:`Category ‘${x}’ already exists in group (May be Hidden)`}))},T=async x=>{if((await V("get-categories")).grouped.filter(j=>j.id===x.cat_group)[0].categories.filter(j=>j.name.toUpperCase()===x.name.toUpperCase()).filter(j=>x.id==="new"?!0:j.id!==x.id).length>0){N(x.name);return}x.id==="new"?o(zs(x.name,x.cat_group,x.is_income,x.hidden)):o(Qs(x))},I=async x=>{const A=await V("must-category-transfer",{id:x});o(A?Le("confirm-category-delete",{category:x,onDelete:y=>{x!==y&&o(ln(x,y))}}):ln(x))},D=x=>{x.id==="new"?o(Vs(x.name)):o(Zs(x))},E=async x=>{const A=B.find(j=>j.id===x);let y=!1;for(const j of A.categories)if(await V("must-category-transfer",{id:j.id})){y=!0;break}o(y?Le("confirm-category-delete",{group:x,onDelete:j=>{o(cn(x,j))}}):cn(x))},W=(x,A,y)=>{o(qs(x,A,y))},O=(x,A)=>{i("/accounts",{state:{goBack:!0,filterConditions:[{field:"category",op:"is",value:x,type:"id"},{field:"date",op:"is",value:A,options:{month:!0},type:"date"}],categoryId:x}})},z=async x=>{const A=await V("get-categories"),y=A.list.filter(k=>k.id===x.id)[0];if(A.grouped.filter(k=>k.id===x.groupId)[0].categories.filter(k=>k.name.toUpperCase()===y.name.toUpperCase()).filter(k=>k.id!==y.id).length>0){N(y.name);return}o(Ks(x.id,x.groupId,x.targetId))},Y=async x=>{o(Ys(x.id,x.targetId))},J=()=>{l(!r)},{reportComponents:H,rolloverComponents:ee}=n;if(!b||!B)return null;let L;return v==="report"?L=e.jsx(jo,{summaryCollapsed:r,onBudgetAction:W,onToggleSummaryCollapse:J,children:e.jsx(_t,{type:v,prewarmStartMonth:c,startMonth:c,monthBounds:f,maxMonths:S,dataComponents:H,onMonthSelect:R,onDeleteCategory:I,onDeleteGroup:E,onSaveCategory:T,onSaveGroup:D,onBudgetAction:W,onShowActivity:O,onReorderCategory:z,onReorderGroup:Y})}):L=e.jsx(To,{summaryCollapsed:r,onBudgetAction:W,onToggleSummaryCollapse:J,children:e.jsx(_t,{type:v,prewarmStartMonth:c,startMonth:c,monthBounds:f,maxMonths:S,dataComponents:ee,onMonthSelect:R,onDeleteCategory:I,onDeleteGroup:E,onSaveCategory:T,onSaveGroup:D,onBudgetAction:W,onShowActivity:O,onReorderCategory:z,onReorderGroup:Y})}),e.jsx(ze.Provider,{value:tt(c),children:e.jsx(g,{style:{flex:1},children:L})})}const rs=u.memo(n=>e.jsx(es,{...n}));rs.displayName="RolloverBudgetSummary";function hi(){const n=u.useMemo(()=>({SummaryComponent:Un,ExpenseCategoryComponent:Zn,ExpenseGroupComponent:Vn,IncomeCategoryComponent:Kn,IncomeGroupComponent:qn,BudgetTotalsComponent:zn,IncomeHeaderComponent:Qn}),[So]),t=u.useMemo(()=>({SummaryComponent:rs,ExpenseCategoryComponent:as,ExpenseGroupComponent:ss,IncomeCategoryComponent:is,IncomeGroupComponent:os,BudgetTotalsComponent:ts,IncomeHeaderComponent:ns}),[Mo]);return e.jsx(g,{style:{...G.page,paddingLeft:8,paddingRight:8,overflow:"hidden"},children:e.jsx(Ro,{reportComponents:n,rolloverComponents:t})})}function pi(){const{pushModal:n}=Tn(),[t,s]=u.useState(""),o=Js();if(o==null)return null;const{schedules:i,statuses:r}=o;function l(f){n("schedule-edit",{id:f})}function a(){n("schedule-edit")}function d(){n("schedules-discover")}async function c(f,h){switch(f){case"post-transaction":await V("schedule/post-transaction",{id:h});break;case"skip":await V("schedule/skip-next-date",{id:h});break;case"complete":await V("schedule/update",{schedule:{id:h,completed:!0}});break;case"restart":await V("schedule/update",{schedule:{id:h,completed:!1},resetNextDate:!0});break;case"delete":await V("schedule/delete",{id:h});break}}return e.jsxs(ea,{header:"Schedules",children:[e.jsx(g,{style:{flexDirection:"row",alignItems:"center",padding:"0 0 15px"},children:e.jsx(g,{style:{flex:1,flexDirection:"row",justifyContent:"flex-end"},children:e.jsx(kn,{placeholder:"Filter schedules…",value:t,onChange:s})})}),e.jsx(ta,{schedules:i,filter:t,statuses:r,allowCompleted:!0,onSelect:l,onAction:c,style:{backgroundColor:m.tableBackground}}),e.jsxs(g,{style:{flexDirection:"row",justifyContent:"space-between",margin:"20px 0",flexShrink:0},children:[e.jsx(be,{onPress:d,children:"Find schedules"}),e.jsx(be,{variant:"primary",onPress:a,children:"Add new schedule"})]})]})}function fi(){return window.close(),e.jsx(na,{isCurrent:!0,title:"Account sync",children:()=>e.jsxs(g,{style:{maxWidth:500},children:[e.jsx(dn,{children:"Please wait..."}),e.jsx(dn,{children:"The window should close automatically. If nothing happened you can close this window or tab."})]})})}function ls(n,t){return!!([n,t].every(s=>s.transfer_id==null&&s.is_child===!1)&&n.account!==t.account&&n.amount+t.amount===0)}const cs=u.createContext(null);function Yt(){const n=u.useContext(cs);return u.useMemo(()=>({...n,expanded:t=>n.state.mode==="collapse"?!n.state.ids.has(t):n.state.ids.has(t)}),[n])}function Ao({children:n,initialMode:t="expand"}){const s=$e(a=>a.app.lastSplitState),o=Qe(),[i,r]=u.useReducer((a,d)=>{switch(d.type){case"toggle-split":{const c=new Set([...a.ids]),{id:f}=d;return c.has(f)?c.delete(f):c.add(f),{...a,ids:c}}case"open-split":{const c=new Set([...a.ids]),{id:f}=d;return a.mode==="collapse"?c.delete(f):c.add(f),{...a,ids:c}}case"set-mode":return{...a,mode:d.mode,ids:new Set,transitionId:null};case"switch-mode":return a.transitionId!=null?a:{...a,mode:a.mode==="expand"?"collapse":"expand",transitionId:d.id,ids:new Set};case"finish-switch-mode":return{...a,transitionId:null};default:throw new Error("Unknown action type: "+d.type)}},s.current||{ids:new Set,mode:t});u.useEffect(()=>{i.transitionId!=null&&setTimeout(()=>{r({type:"finish-switch-mode"})},250)},[i.transitionId]),u.useEffect(()=>{i.transitionId==null&&o({type:"SET_LAST_SPLIT_STATE",splitState:i})},[o,i]);const l=u.useMemo(()=>({state:i,dispatch:r}),[i,r]);return e.jsx(cs.Provider,{value:l,children:n})}var Io=Xa,ds=/[\\^$.*+?()[\]{}|]/g,Po=RegExp(ds.source);function Do(n){return n=Io(n),n&&Po.test(n)?n.replace(ds,"\\$&"):n}var Eo=Do;const Lo=sa(Eo);function _o(n,t){return n?n[t]:""}function At(n,t){let{amount:s,date:o}=n;He(n.id)&&(s=(n._inverse?-1:1)*St(s));let i=s<0?-s:null,r=s>0?s:null;return s===0&&(t?r=0:i=0),fa(Dn(o))||(o=null),{...n,date:o,debit:i!=null?De(i):"",credit:r!=null?De(r):""}}function Fo(n,t){const{debit:s,credit:o,date:i,...r}=n;let l;if(s!==""){const d=Ue(s,null);l=d!=null?-d:null}else l=Ue(o,null);l=l!=null?ot(l):t.amount;let a=i;return a==null&&(a=t.date||zt()),{...r,date:a,amount:l}}function us(n,t){const s=n[t];return s&&s.is_child&&(n[t+1]==null||n[t+1].parent_id!==s.parent_id)}function Ae(n,t,s,o="asc"){return n===s?t==="asc"?"desc":"asc":o}const hs=u.memo(({hasSelected:n,showAccount:t,showCategory:s,showBalance:o,showCleared:i,scrollWidth:r,onSort:l,ascDesc:a,field:d})=>{const c=Bn();return re("ctrl+a, cmd+a, meta+a",f=>c({type:"select-all",event:f}),{preventDefault:!0,scopes:["app"]},[c]),e.jsxs(Be,{style:{fontWeight:300,zIndex:200,color:m.tableHeaderText,backgroundColor:m.tableBackground,paddingRight:`${5+(r??0)}px`,borderTopWidth:1,borderBottomWidth:1,borderColor:m.tableBorder},children:[e.jsx(Mn,{exposed:!0,focused:!1,selected:n,width:20,style:{borderTopWidth:0,borderBottomWidth:0},onSelect:f=>c({type:"select-all",event:f})}),e.jsx(Te,{value:"Date",width:110,alignItems:"flex",marginLeft:-5,id:"date",icon:d==="date"?a:"clickable",onClick:()=>l("date",Ae(d,a,"date","desc"))}),t&&e.jsx(Te,{value:"Account",width:"flex",alignItems:"flex",marginLeft:-5,id:"account",icon:d==="account"?a:"clickable",onClick:()=>l("account",Ae(d,a,"account","asc"))}),e.jsx(Te,{value:"Payee",width:"flex",alignItems:"flex",marginLeft:-5,id:"payee",icon:d==="payee"?a:"clickable",onClick:()=>l("payee",Ae(d,a,"payee","asc"))}),e.jsx(Te,{value:"Notes",width:"flex",alignItems:"flex",marginLeft:-5,id:"notes",icon:d==="notes"?a:"clickable",onClick:()=>l("notes",Ae(d,a,"notes","asc"))}),s&&e.jsx(Te,{value:"Category",width:"flex",alignItems:"flex",marginLeft:-5,id:"category",icon:d==="category"?a:"clickable",onClick:()=>l("category",Ae(d,a,"category","asc"))}),e.jsx(Te,{value:"Payment",width:100,alignItems:"flex-end",marginRight:-5,id:"payment",icon:d==="payment"?a:"clickable",onClick:()=>l("payment",Ae(d,a,"payment","asc"))}),e.jsx(Te,{value:"Deposit",width:100,alignItems:"flex-end",marginRight:-5,id:"deposit",icon:d==="deposit"?a:"clickable",onClick:()=>l("deposit",Ae(d,a,"deposit","desc"))}),o&&e.jsx(Te,{value:"Balance",width:103,alignItems:"flex-end",marginRight:-5,id:"balance"}),i&&e.jsx(Te,{value:"✓",width:38,alignItems:"center",id:"cleared",icon:d==="cleared"?a:"clickable",onClick:()=>{l("cleared",Ae(d,a,"cleared","asc"))}})]})});hs.displayName="TransactionHeader";function ps(n,t,s,o=0){const i=l=>o>0?`${l} (+${o} more)`:l,{payee:r}=n;return s?e.jsx(g,{style:{flexDirection:"row",alignItems:"center"},children:e.jsx("div",{style:{overflow:"hidden",textOverflow:"ellipsis"},children:i(s.name)})}):t?i(t.name):r&&r.startsWith("new:")?i(r.slice(4)):""}function No({id:n,focused:t,selected:s,status:o,isChild:i,isPreview:r,onEdit:l,onUpdate:a}){const d=o==="cleared"||o==="reconciled"||o==null,c=ga(o),f=o==="cleared"?m.noticeTextLight:o==="reconciled"?m.noticeTextLight:o==="missed"?m.errorText:o==="due"?m.warningText:s?m.pageTextLinkLight:m.pageTextSubdued;function h(){d&&a("cleared",o!=="cleared")}return e.jsx(Pe,{name:"cleared",width:38,alignItems:"center",focused:t,style:{padding:1},plain:!0,children:e.jsx(Qt,{style:{padding:3,backgroundColor:"transparent",border:"1px solid transparent",borderRadius:50,":focus":{...r?{boxShadow:"none"}:{border:"1px solid "+m.formInputBorderSelected,boxShadow:"0 1px 2px "+m.formInputBorderSelected}},cursor:d?"pointer":"default",...i&&{visibility:"hidden"}},disabled:r||i,onEdit:()=>l(n,"cleared"),onSelect:h,children:u.createElement(c.Icon,{style:{width:13,height:13,color:f,marginTop:o==="due"?-1:0}})})})}function Te({value:n,id:t,width:s,alignItems:o,marginLeft:i,marginRight:r,icon:l,onClick:a}){const d={whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:m.tableHeaderText,fontWeight:300,marginLeft:i,marginRight:r};return e.jsx(Ke,{width:s,name:t,alignItems:o,value:n,style:{borderTopWidth:0,borderBottomWidth:0},unexposedContent:({value:c})=>a?e.jsxs(K,{type:"bare",onClick:a,style:d,children:[e.jsx(Rn,{value:c}),l==="asc"&&e.jsx(no,{width:10,height:10,style:{marginLeft:5}}),l==="desc"&&e.jsx(so,{width:10,height:10,style:{marginLeft:5}})]}):e.jsx(X,{style:d,children:c})})}const Oo=(n,t,s)=>u.useMemo(()=>{if(!t)return null;const{counts:o,mostCommonPayeeTransaction:i}=t?.reduce(({counts:a,...d},c)=>c.payee&&(a[c.payee]=(a[c.payee]||0)+1,a[c.payee]>d.maxCount)?{counts:a,maxCount:a[c.payee],mostCommonPayeeTransaction:c}:{counts:a,...d},{counts:{},maxCount:0,mostCommonPayeeTransaction:null})||{};if(!i)return"Split (no payee)";const r=Gt(n)[i.payee],l=Object.keys(o).length;return ps(i,r,s[i.id],l-1)},[t,n,s]);function Ho({id:n,payee:t,focused:s,payees:o,accounts:i,transferAccountsByTransaction:r,valueStyle:l,transaction:a,subtransactions:d,isPreview:c,onEdit:f,onUpdate:h,onCreatePayee:w,onManagePayees:v,onNavigateToTransferAccount:p,onNavigateToSchedule:S}){const b=u.useRef(!1),C=Qe(),B=Oo(o,d,r),P=r[a.id];return a.is_parent?e.jsx(Pe,{name:"payee",width:"flex",focused:s,style:{padding:0},plain:!0,children:e.jsx(Qt,{bare:!0,style:{alignSelf:"flex-start",borderRadius:4,border:"1px solid transparent",":hover":{border:"1px solid "+m.buttonNormalBorder}},disabled:c,onSelect:()=>C(Le("payee-autocomplete",{onSelect:R=>{h("payee",R)}})),children:e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",alignSelf:"stretch",borderRadius:4,flex:1,padding:4,color:m.pageTextSubdued},children:[e.jsx(xa,{style:{color:"inherit",width:14,height:14,marginRight:5}}),e.jsx(X,{style:{fontStyle:"italic",fontWeight:300,userSelect:"none"},children:B})]})})}):e.jsx(Ke,{width:"flex",name:"payee",textAlign:"flex",value:t?.id,valueStyle:l,exposed:s,onExpose:R=>!c&&f(n,R),onUpdate:async R=>{if(h("payee",R),R&&R.startsWith("new:")&&!b.current){b.current=!0;const N=await w(R.slice(4));h("payee",N),b.current=!1}},formatter:()=>ps(a,t,P),unexposedContent:R=>e.jsxs(e.Fragment,{children:[e.jsx(Wo,{transaction:a,transferAccount:P,onNavigateToTransferAccount:p,onNavigateToSchedule:S}),e.jsx(Rn,{...R})]}),children:({onBlur:R,onKeyDown:N,onUpdate:T,onSave:I,shouldSaveFromKey:D,inputStyle:E})=>e.jsx(ma,{payees:o,accounts:i,value:t?.id,shouldSaveFromKey:D,inputProps:{onBlur:R,onKeyDown:N,style:E},showManagePayees:!0,clearOnBlur:!1,focused:!0,onUpdate:(W,O)=>T?.(O),onSelect:I,onManagePayees:()=>v(t?.id),menuPortalTarget:void 0})})}function Wo({transaction:n,transferAccount:t,onNavigateToTransferAccount:s,onNavigateToSchedule:o}){const i=n.schedule,r=En(),l=i&&r?r.schedules.find(h=>h.id===i):null;if(l==null&&t==null)return null;const a={marginLeft:-5,marginRight:2,width:23,height:23,color:"inherit"},d={width:13,height:13},c={width:10,height:10},f=l&&l._date&&!!l._date.frequency;return e.jsxs(e.Fragment,{children:[l&&e.jsx(K,{type:"bare",style:a,onClick:h=>{h.stopPropagation(),o(i)},children:f?e.jsx(ya,{style:d}):e.jsx(ba,{style:d})}),t&&e.jsx(K,{type:"bare","aria-label":"Transfer",style:a,onClick:h=>{h.stopPropagation(),he(n.id)||s(t.id)},children:(n._inverse?-1:1)*n.amount>0?e.jsx(to,{style:c}):e.jsx(wa,{style:c})})]})}const fs=u.memo(function({allTransactions:t,transaction:s,subtransactions:o,transferAccountsByTransaction:i,editing:r,showAccount:l,showBalance:a,showCleared:d,showZeroInDeposit:c,style:f,selected:h,highlighted:w,added:v,matched:p,expanded:S,focusedField:b,categoryGroups:C,payees:B,accounts:P,balance:R,dateFormat:N="MM/dd/yyyy",hideFraction:T,onSave:I,onEdit:D,onDelete:E,onSplit:W,onManagePayees:O,onCreatePayee:z,onToggleSplit:Y,onNavigateToTransferAccount:J,onNavigateToSchedule:H,onNotesTagClick:ee,splitError:L,listContainerRef:x}){const A=Qe(),y=Bn(),j=u.useRef(null),[k,F]=u.useState(c),[Q,ne]=u.useState(s),[_,$]=u.useState(()=>At(s,c)),Z=He(_.id);(s!==Q||c!==k)&&($(At(s,c)),ne(s),F(c));const[pe,se]=u.useState(!1);function q(M,te){_[M]!==te&&(_.reconciled===!0&&(M==="credit"||M==="debit"||M==="payee"||M==="account"||M==="date")?pe===!1&&(se(!0),A(Le("confirm-transaction-edit",{onCancel:()=>{se(!1)},onConfirm:()=>{se(!1),me(M,te)},confirmReason:"editReconciled"}))):me(M,te)),M==="cleared"&&_.reconciled&&A(Le("confirm-transaction-edit",{onConfirm:()=>{me("reconciled",!1)},confirmReason:"unlockReconciled"}))}function me(M,te){const ge={..._,[M]:te};if(!(M==="note"&&te===""&&_.note==null))if(M==="account"&&te&&gt(P)[te].offbudget&&(ge.category=null),M==="credit"?ge.debit="":M==="debit"&&(ge.credit=""),M==="account"&&_.account!==te&&(ge.reconciled=!1),M==="payee"&&te&&te.startsWith("new:"))$(ge);else{const Re=Fo(ge,s);$(At(Re,c));const Oe=["credit","debit"].includes(M)?"amount":M;I(Re,o,Oe)}}const{id:U,amount:Ze,debit:_e,credit:Fe,payee:ct,imported_payee:dt,notes:oe,date:Ne,account:ye,category:Se,cleared:ut,reconciled:ht,is_parent:we,_unmatched:Xt=!1,_inverse:Tt=!1}=_,Ce=B&&ct&&Gt(B)[ct],pt=P&&ye&&gt(P)[ye],fe=_.is_child,le=i[U],ft=le&&le.offbudget===0,Jt=pt&&pt.offbudget===1,Me=v?{fontWeight:600}:null,en=b==="select",kt=T?{letterSpacing:-.5}:null,Bt=he(U)?R+(Tt?-1:1)*Ze:R,[ms,ys]=u.useState(1);return u.useEffect(()=>{L&&setTimeout(()=>{ys(M=>M+1)},1)},[L,t]),e.jsxs(Be,{ref:j,style:{backgroundColor:h?m.tableRowBackgroundHighlight:en?m.tableRowBackgroundHover:m.tableBackground,":hover":!(en||h)&&{backgroundColor:m.tableRowBackgroundHover},"& .hover-visible":{opacity:0},":hover .hover-visible":{opacity:1},...w||h?{color:m.tableRowBackgroundHighlightText}:{color:m.tableText},...f,...Z&&{color:m.tableTextInactive,fontStyle:"italic"},...Xt&&{opacity:.5}},children:[L&&x.current&&e.jsx(ie,{arrowSize:ms,triggerRef:j,isOpen:!0,isNonModal:!0,style:{width:375,padding:5,maxHeight:"38px !important"},shouldFlip:!1,placement:"bottom end",UNSTABLE_portalContainer:x.current,children:L}),fe&&e.jsx(We,{width:110,style:{width:110,backgroundColor:m.tableRowBackgroundHover,border:0}}),fe&&l&&e.jsx(We,{style:{flex:1,backgroundColor:m.tableRowBackgroundHover,border:0}}),he(_.id)?fe?e.jsx(la,{onDelete:()=>E&&E(_.id),exposed:r,style:{...fe&&{borderLeftWidth:1},lineHeight:0}}):e.jsx(Pe,{width:20}):e.jsx(Mn,{exposed:!0,buttonProps:{className:h||r?null:"hover-visible"},focused:b==="select",onSelect:M=>{y({type:"select",id:_.id,event:M})},onEdit:()=>D(U,"select"),selected:h,style:{...fe&&{borderLeftWidth:1}},value:p&&e.jsx(co,{style:{width:13,height:13,color:"inherit"}})}),!fe&&e.jsx(Ke,{name:"date",width:110,textAlign:"flex",exposed:b==="date",value:Ne,valueStyle:Me,formatter:M=>M?ca(Dn(M),N):"",onExpose:M=>!Z&&D(U,M),onUpdate:M=>{q("date",M)},children:({onBlur:M,onKeyDown:te,onUpdate:ge,onSave:Re,shouldSaveFromKey:Oe,inputStyle:qe})=>e.jsx(da,{value:Ne||"",dateFormat:N,inputProps:{onBlur:M,onKeyDown:te,style:qe},shouldSaveFromKey:Oe,clearOnBlur:!0,onUpdate:ge,onSelect:Re})}),!fe&&l&&e.jsx(Ke,{name:"account",width:"flex",textAlign:"flex",value:ye,formatter:M=>{const te=M&&gt(P)[M];return te?te.name:""},valueStyle:Me,exposed:b==="account",onExpose:M=>!Z&&D(U,M),onUpdate:async M=>{M&&q("account",M)},children:({onBlur:M,onKeyDown:te,onUpdate:ge,onSave:Re,shouldSaveFromKey:Oe,inputStyle:qe})=>e.jsx(ua,{includeClosedAccounts:!1,value:ye,accounts:P,shouldSaveFromKey:Oe,clearOnBlur:!1,focused:!0,inputProps:{onBlur:M,onKeyDown:te,style:qe},onUpdate:ge,onSelect:Re,menuPortalTarget:void 0})}),e.jsx(Ho,{id:U,payee:Ce,focused:b==="payee",accounts:P.filter(M=>M.id!==ye),payees:B.filter(M=>M.transfer_acct!==ye),valueStyle:Me,transaction:_,subtransactions:o,transferAccountsByTransaction:i,importedPayee:dt,isPreview:Z,onEdit:D,onUpdate:q,onCreatePayee:z,onManagePayees:O,onNavigateToTransferAccount:J,onNavigateToSchedule:H}),Z?e.jsx(Pe,{name:"notes",width:"flex"}):e.jsx(Ge,{width:"flex",name:"notes",textAlign:"flex",exposed:b==="notes",focused:b==="notes",value:oe||"",valueStyle:Me,formatter:M=>Uo(M,ee),onExpose:M=>!Z&&D(U,M),inputProps:{value:oe||"",onUpdate:q.bind(null,"notes")}}),Z?e.jsx(Pe,{width:"flex",style:{alignItems:"flex-start"},exposed:!0,children:()=>e.jsx(g,{style:{color:oe==="missed"?m.errorText:oe==="due"?m.warningText:h?m.formLabelText:m.upcomingText,backgroundColor:oe==="missed"?m.errorBackground:oe==="due"?m.warningBackground:h?m.formLabelBackground:m.upcomingBackground,margin:"0 5px",padding:"3px 7px",borderRadius:4},children:ha(oe)})}):we?e.jsx(Pe,{name:"category",width:"flex",focused:b==="category",style:{padding:0},plain:!0,children:e.jsx(Qt,{bare:!0,style:{alignSelf:"flex-start",borderRadius:4,border:"1px solid transparent",":hover":{border:"1px solid "+m.buttonNormalBorder}},disabled:he(_.id),onEdit:()=>D(U,"category"),onSelect:()=>Y(U),children:e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",alignSelf:"stretch",borderRadius:4,flex:1,padding:4,color:m.pageTextSubdued},children:[we&&e.jsx(nt,{style:{color:"inherit",width:14,height:14,transition:"transform .08s",transform:S?"rotateZ(0)":"rotateZ(-90deg)"}}),e.jsx(X,{style:{fontStyle:"italic",fontWeight:300,userSelect:"none"},children:"Split"})]})})}):ft||Jt||Z?e.jsx(Ge,{name:"category",width:"flex",exposed:b==="category",focused:b==="category",onExpose:M=>!Z&&D(U,M),value:we?"Split":Jt?"Off Budget":ft?"Transfer":"",valueStyle:Me,style:{fontStyle:"italic",color:m.pageTextSubdued,fontWeight:300},inputProps:{readOnly:!0,style:{fontStyle:"italic"}}}):e.jsx(Ke,{name:"category",width:"flex",textAlign:"flex",value:Se,formatter:M=>M?_o(pa(C)[M],"name"):_.id?"Categorize":"",exposed:b==="category",onExpose:M=>D(U,M),valueStyle:Se?Me:{fontStyle:"italic",fontWeight:300,color:m.formInputTextHighlight},onUpdate:async M=>{M==="split"?W(_.id):q("category",M)},children:({onBlur:M,onKeyDown:te,onUpdate:ge,onSave:Re,shouldSaveFromKey:Oe,inputStyle:qe})=>e.jsx(ze.Provider,{value:tt(Et(_.date)),children:e.jsx($t,{categoryGroups:C,value:Se,focused:!0,clearOnBlur:!1,showSplitOption:!fe&&!we,shouldSaveFromKey:Oe,inputProps:{onBlur:M,onKeyDown:te,style:qe},onUpdate:ge,onSelect:Re,menuPortalTarget:void 0,showHiddenCategories:!1})})}),e.jsx(Ge,{type:"input",width:100,name:"debit",exposed:b==="debit",focused:b==="debit",value:_e===""&&Fe===""?"0.00":_e,valueStyle:Me,textAlign:"right",title:_e,onExpose:M=>!Z&&D(U,M),style:{...we&&{fontStyle:"italic"},...G.tnum,...kt},inputProps:{value:_e===""&&Fe===""?"0.00":_e,onUpdate:q.bind(null,"debit")},privacyFilter:{activationFilters:[!he(_.id)]}}),e.jsx(Ge,{type:"input",width:100,name:"credit",exposed:b==="credit",focused:b==="credit",value:Fe,valueStyle:Me,textAlign:"right",title:Fe,onExpose:M=>!Z&&D(U,M),style:{...we&&{fontStyle:"italic"},...G.tnum,...kt},inputProps:{value:Fe,onUpdate:q.bind(null,"credit")},privacyFilter:{activationFilters:[!he(_.id)]}}),a&&e.jsx(Pe,{name:"balance",value:Bt==null||fe?"":De(Bt),valueStyle:{color:Bt<0?m.errorText:m.noticeTextLight},style:{...G.tnum,...kt},width:103,textAlign:"right",privacyFilter:!0}),d&&e.jsx(No,{id:U,focused:b==="cleared",selected:h,isPreview:Z,status:Z?oe:ht?"reconciled":ut?"cleared":null,isChild:fe,onEdit:D,onUpdate:q}),e.jsx(Pe,{width:5})]})});function gs({error:n,isDeposit:t,onAddSplit:s,onDistributeRemainder:o,style:i,canDistributeRemainder:r}){switch(n.type){case"SplitTransactionError":if(n.version===1)return e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",padding:"0 5px",...i},"data-testid":"transaction-error",children:[e.jsxs(X,{children:["Amount left:"," ",e.jsx(X,{style:{fontWeight:500},children:De(t?n.difference:-n.difference)})]}),e.jsx(g,{style:{flex:1}}),e.jsx(K,{type:"normal",style:{marginLeft:15},onClick:o,"data-testid":"distribute-split-button",disabled:!r,children:"Distribute"}),e.jsx(K,{type:"primary",style:{marginLeft:10,padding:"4px 10px"},onClick:s,"data-testid":"add-split-button",children:"Add Split"})]});break;default:return null}}function It(n,t,s){return[{id:"temp",date:s||zt(),account:n||null,category:t||null,cleared:!1,amount:null}]}function $o({transactions:n,accounts:t,categoryGroups:s,payees:o,transferAccountsByTransaction:i,editingTransaction:r,focusedField:l,showAccount:a,showCategory:d,showBalance:c,showCleared:f,dateFormat:h,hideFraction:w,onClose:v,onSplit:p,onEdit:S,onDelete:b,onSave:C,onAdd:B,onAddSplit:P,onDistributeRemainder:R,onManagePayees:N,onCreatePayee:T,onNavigateToTransferAccount:I,onNavigateToSchedule:D,onNotesTagClick:E,balance:W}){const O=n[0].error,z=n[0].amount>0,Y=n.filter(H=>H.parent_id===n[0].id),J=Y.filter(H=>H.amount===0);return e.jsxs(g,{style:{borderBottom:"1px solid "+m.tableBorderHover,paddingBottom:6,backgroundColor:m.tableBackground},"data-testid":"new-transaction",onKeyDown:H=>{H.key==="Escape"&&v()},children:[n.map(H=>e.jsx(fs,{isNew:!0,editing:r===H.id,transaction:H,subtransactions:H.is_parent?Y:null,transferAccountsByTransaction:i,showAccount:a,showCategory:d,showBalance:c,showCleared:f,focusedField:r===H.id&&l,showZeroInDeposit:z,accounts:t,categoryGroups:s,payees:o,dateFormat:h,hideFraction:w,expanded:!0,onEdit:S,onSave:C,onSplit:p,onDelete:b,onAdd:B,onManagePayees:N,onCreatePayee:T,style:{marginTop:-1},onNavigateToTransferAccount:I,onNavigateToSchedule:D,onNotesTagClick:E,balance:W},H.id)),e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",justifyContent:"flex-end",marginTop:6,marginRight:20},children:[e.jsx(K,{style:{marginRight:10,padding:"4px 10px"},onClick:()=>v(),"data-testid":"cancel-button",children:"Cancel"}),O?e.jsx(gs,{error:O,isDeposit:z,onAddSplit:()=>P(n[0].id),onDistributeRemainder:()=>R(n[0].id),canDistributeRemainder:J.length>0}):e.jsx(K,{type:"primary",style:{padding:"4px 10px"},onClick:B,"data-testid":"add-button",children:"Add"})]})]})}function Go({tableNavigator:n,tableRef:t,listContainerRef:s,dateFormat:o="MM/dd/yyyy",newNavigator:i,renderEmpty:r,onScroll:l,...a}){const d=u.createRef(),c=ia(a.isAdding),[f,h]=u.useState(0);function w(C,B){const P=C>0&&B>0&&C-B;h(P||0)}const v=u.useCallback(C=>{a.onCloseAddTransaction(),a.onNavigateToTransferAccount(C)},[a.onCloseAddTransaction,a.onNavigateToTransferAccount]),p=u.useCallback(C=>{a.onCloseAddTransaction(),a.onNavigateToSchedule(C)},[a.onCloseAddTransaction,a.onNavigateToSchedule]),S=u.useCallback(C=>{a.onCloseAddTransaction(),a.onNotesTagClick(C)},[a.onCloseAddTransaction,a.onNotesTagClick]);u.useEffect(()=>{!c&&a.isAdding&&i.onEdit("temp","date")},[c,a.isAdding,i]);const b=({item:C,index:B,editing:P})=>{const{transactions:R,selectedItems:N,accounts:T,categoryGroups:I,payees:D,showCleared:E,showAccount:W,showCategory:O,showBalances:z,balances:Y,hideFraction:J,isNew:H,isMatched:ee,isExpanded:L}=a,x=C,A=N.has(x.id),y=a.transactionMap.get(x.parent_id),j=y&&y.amount>0,k=L&&L((y||x).id),F=k&&y&&y.error||x.error,Q=(!k||us(R,B))&&F&&F.type==="SplitTransactionError",ne=x.is_parent?a.transactionsByParent[x.id]:null,_=a.transactionsByParent[x.is_parent?x.id:x.parent_id]?.filter($=>$.amount===0);return e.jsx(fs,{allTransactions:a.transactions,editing:P,transaction:x,transferAccountsByTransaction:a.transferAccountsByTransaction,subtransactions:ne,showAccount:W,showCategory:O,showBalance:z,showCleared:E,selected:A,highlighted:!1,added:H?.(x.id),expanded:L?.(x.id),matched:ee?.(x.id),showZeroInDeposit:j,balance:Y?.[x.id]?.balance,focusedField:P&&n.focusedField,accounts:T,categoryGroups:I,payees:D,dateFormat:o,hideFraction:J,onEdit:n.onEdit,onSave:a.onSave,onDelete:a.onDelete,onSplit:a.onSplit,onManagePayees:a.onManagePayees,onCreatePayee:a.onCreatePayee,onToggleSplit:a.onToggleSplit,onNavigateToTransferAccount:v,onNavigateToSchedule:p,onNotesTagClick:S,splitError:Q&&e.jsx(gs,{error:F,isDeposit:j,onAddSplit:()=>a.onAddSplit(x.id),onDistributeRemainder:()=>a.onDistributeRemainder(x.id),canDistributeRemainder:_.length>0}),listContainerRef:s})};return e.jsxs(g,{innerRef:d,style:{flex:1,cursor:"default",...a.style},children:[e.jsxs(g,{children:[e.jsx(hs,{hasSelected:a.selectedItems.size>0,showAccount:a.showAccount,showCategory:a.showCategory,showBalance:a.showBalances,showCleared:a.showCleared,scrollWidth:f,onSort:a.onSort,ascDesc:a.ascDesc,field:a.sortField}),a.isAdding&&e.jsx(g,{...i.getNavigatorProps({onKeyDown:C=>a.onCheckNewEnter(C)}),children:e.jsx($o,{transactions:a.newTransactions,transferAccountsByTransaction:a.transferAccountsByTransaction,editingTransaction:i.editingId,focusedField:i.focusedField,accounts:a.accounts,categoryGroups:a.categoryGroups,payees:a.payees||[],showAccount:a.showAccount,showCategory:a.showCategory,showBalance:a.showBalances,showCleared:a.showCleared,dateFormat:o,hideFraction:a.hideFraction,onClose:a.onCloseAddTransaction,onAdd:a.onAddTemporary,onAddSplit:a.onAddSplit,onSplit:a.onSplit,onEdit:i.onEdit,onSave:a.onSave,onDelete:a.onDelete,onManagePayees:a.onManagePayees,onCreatePayee:a.onCreatePayee,onNavigateToTransferAccount:v,onNavigateToSchedule:p,onNotesTagClick:S,onDistributeRemainder:a.onDistributeRemainder,balance:a.transactions?.length>0?a.balances?.[a.transactions[0]?.id]?.balance:0})})]}),e.jsxs(g,{style:{flex:1,overflow:"hidden"},"data-testid":"transaction-table",children:[e.jsx(ra,{navigator:n,ref:t,listContainerRef:s,items:a.transactions,renderItem:b,renderEmpty:r,loadMore:a.loadMoreTransactions,isSelected:C=>a.selectedItems.has(C),onKeyDown:C=>a.onCheckEnter(C),onScroll:l,saveScrollWidth:w}),a.isAdding&&e.jsx("div",{style:{position:"absolute",top:-20,left:0,right:0,height:20,backgroundColor:m.errorText,boxShadow:"0 0 6px rgba(0, 0, 0, .20)"}},"shadow")]})]})}const xs=u.forwardRef((n,t)=>{const[s,o]=u.useState(null),[i,r]=u.useState(!1),l=Yt(),a=u.useRef(null),d=u.useRef(null),c=u.useRef(null),f=aa(d,t),h=u.useMemo(()=>{let y;if(l.state.transitionId!=null){const j=n.transactions.findIndex(k=>k.id===l.state.transitionId);y=n.transactions.filter((k,F)=>{if(k.parent_id){if(F>=j)return l.expanded(k.parent_id);if(a.current)return a.current.expanded(k.parent_id)}return!0})}else a.current&&a.current.state.transitionId!=null&&(d.current.anchor(),d.current.setRowAnimation(!1)),a.current=l,y=n.transactions.filter(j=>j.parent_id?l.expanded(j.parent_id):!0);return a.current=l,y},[n.transactions,l]),w=u.useMemo(()=>new Map(h.map(y=>[y.id,y])),[h]),v=u.useMemo(()=>n.transactions.reduce((y,j)=>(j.is_child&&(y[j.parent_id]=[...y[j.parent_id]??[],j]),y),{}),[n.transactions]),p=u.useMemo(()=>{if(!n.accounts)return{};const y=gt(n.accounts),j=Gt(n.payees);return Object.fromEntries(n.transactions.map(k=>{if(!n.accounts)return[k.id,null];const F=k.payee&&j[k.payee];let Q;return k._inverse?Q=k.account&&y[k.account]:Q=F?.transfer_acct&&y[F.transfer_acct],[k.id,Q||null]}))},[n.transactions,n.payees,n.accounts]);u.useEffect(()=>{d.current.isAnchored()&&(d.current.unanchor(),d.current.setRowAnimation(!0))},[a.current]);const S=un(s,D),b=un(h,D),C=u.useRef(!1),B=u.useRef({newTransactions:s,newNavigator:S,tableNavigator:b}),P=u.useRef(!1),R=u.useRef(!1),[N,T]=u.useState({}),I=Ut();u.useLayoutEffect(()=>{B.current={newTransactions:s,newNavigator:S,tableNavigator:b,transactions:n.transactions}}),i!==n.isAdding&&(!i&&n.isAdding&&o(It(n.currentAccountId,n.currentCategoryId)),r(n.isAdding)),u.useEffect(()=>{if(C.current){if(s[0].account==null)n.addNotification({type:"error",message:"Account is a required field"}),S.onEdit("temp","account");else{const y=B.current.newTransactions,j=y.length>0?y[0].date:null;o(It(n.currentAccountId,n.currentCategoryId,j)),S.onEdit("temp","date"),n.onAdd(y)}C.current=!1}}),u.useEffect(()=>{P.current&&R.current&&(R.current(n),R.current=null),P.current=!1},[s,n.transactions]);function D(y){let j=["select","date","account","payee","notes","category","debit","credit","cleared"];return j=y.is_child?["select","payee","notes","category","debit","credit"]:j.filter(k=>(n.showAccount||k!=="account")&&(n.showCategory||k!=="category")),He(y.id)&&(j=["select"]),he(y.id)&&(j=j.slice(1)),j}function E(y){P.current?R.current=y:y(n)}function W(y){if(y.key==="Enter"){if(y.metaKey)y.stopPropagation(),z();else if(!y.shiftKey){let j=function(k){const{newTransactions:F}=k.current;return F[F.length-1]};S.editingId===j(B).id&&y.stopPropagation(),E(()=>{const k=j(B),F=k.parent_id||k.is_parent;B.current.newTransactions[0].error&&S.editingId===k.id?ee(k.id):S.editingId===k.id&&(!F||!k.error)&&z()})}}}function O(y){if(y.key==="Enter"&&!y.shiftKey){const{editingId:j,focusedField:k}=b;E(()=>{const F=B.current.transactions,Q=F.findIndex(_=>_.id===j),ne=F.find(_=>_.id===F[Q]?.parent_id);us(F,Q)&&ne&&ne.error&&k!=="select"&&(y.stopPropagation(),ee(j))})}}const z=u.useCallback(()=>{C.current=!0,T({})},[n.onAdd,S.onEdit]),Y=u.useCallback(async(y,j=null,k=null)=>{P.current=!0;let F=j?oa([y,...j]):y;if(he(y.id)){n.onApplyRules&&(F=await n.onApplyRules(F,k));const Q=B.current.newTransactions;o(Ie(vt(Q,F).data))}else n.onSave(F)},[n.onSave]),J=u.useCallback(y=>{if(he(y)){const k=B.current.newTransactions;if(y===k[0].id)return;o(An(k,y).data)}},[]),H=u.useMemo(()=>y=>{if(he(y)){const{newNavigator:j}=B.current,k=B.current.newTransactions,{data:F,diff:Q}=In(k,y);o(F),k[0].amount===null?j.onEdit(k[0].id,"debit"):j.onEdit(Q.added[0].id,B.current.newNavigator.focusedField)}else{const j=B.current.transactions.find(Q=>Q.id===y),k=n.onSplit(y);l.dispatch({type:"open-split",id:j.id});const{tableNavigator:F}=B.current;j.amount===null?F.onEdit(j.id,"debit"):F.onEdit(k,F.focusedField)}},[n.onSplit,l.dispatch]),ee=u.useCallback(y=>{if(he(y)){const j=B.current.newTransactions,{data:k,diff:F}=Pn(j,y);o(k),S.onEdit(F.added[0].id,B.current.newNavigator.focusedField)}else{const j=n.onAddSplit(y);b.onEdit(j,B.current.tableNavigator.focusedField)}},[n.onAddSplit]),L=u.useCallback(async y=>{const{transactions:j,tableNavigator:k,newTransactions:F}=B.current,Q=he(y)?F:j,ne=Q.find(U=>U.id===y),_=ne.is_parent?ne:Q.find(U=>U.id===ne.parent_id),$=Q.filter(U=>U.parent_id===(ne.is_parent?ne.id:ne.parent_id)),Z=$.filter(U=>U.amount===0),pe=_.amount-$.reduce((U,Ze)=>U+Ze.amount,0),se=Math.floor(pe/Z.length);let q=pe-se*Z.length;const me=new Array(Z.length).fill(se);for(const U in me){if(q===0)break;me[U]+=1,q--}he(y)?S.onEdit(null):k.onEdit(null);for(const U in Z)await Y({...Z[U],amount:me[U]})},[B]);function x(){o(It(n.currentAccountId,n.currentCategoryId)),n.onCloseAddTransaction()}const A=u.useCallback(y=>l.dispatch({type:"toggle-split",id:y}),[l.dispatch]);return e.jsx(Go,{tableRef:f,listContainerRef:c,...n,transactions:h,transactionMap:w,transactionsByParent:v,transferAccountsByTransaction:p,selectedItems:I,isExpanded:l.expanded,onSave:Y,onDelete:J,onSplit:H,onCheckNewEnter:W,onCheckEnter:O,onAddTemporary:z,onAddSplit:ee,onDistributeRemainder:L,onCloseAddTransaction:x,onToggleSplit:A,newTransactions:s,tableNavigator:b,newNavigator:S})});xs.displayName="TransactionTable";function Uo(n,t){const s=n.split(" ");return e.jsx(e.Fragment,{children:s.map((o,i,r)=>{const l=r.length-1===i?"":" ";return o.includes("#")&&o.length>1?o.split("#").map((a,d)=>{if(d===0)return a;if(!a)return"#";const c=`#${a}`;return e.jsxs("span",{children:[e.jsx(K,{type:"bare",style:{display:"inline-flex",padding:"3px 7px",borderRadius:16,userSelect:"none",backgroundColor:m.noteTagBackground,color:m.noteTagText,cursor:"pointer"},hoveredStyle:{backgroundColor:m.noteTagBackgroundHover,color:m.noteTagText},onClick:f=>{f.stopPropagation(),t?.(c)},children:c},i),l]},`${c}${d}`)}):`${o}${l}`})})}async function Ft(n){const t=await V("transactions-batch-update",{...n,learnCategories:!0});return t.length>0?{updates:t}:{}}async function Pt(n,t,s){const o=await Ft(n);s(va(t.newTransaction,o),xt(o,t.data))}function zo({tableRef:n,transactions:t,allTransactions:s,loadMoreTransactions:o,account:i,accounts:r,category:l,categoryGroups:a,payees:d,balances:c,showBalances:f,showCleared:h,showAccount:w,headerContent:v,isAdding:p,isNew:S,isMatched:b,isFiltered:C,dateFormat:B,hideFraction:P,addNotification:R,renderEmpty:N,onSort:T,sortField:I,ascDesc:D,onChange:E,onRefetch:W,onCloseAddTransaction:O,onCreatePayee:z,onApplyFilter:Y}){const J=Qe(),H=u.useRef(),ee=Cn();u.useLayoutEffect(()=>{H.current=t},[t]);const L=u.useCallback(async _=>{_=Lt(_),await Ft({added:_}),W()},[]),x=u.useCallback(async _=>{const $=vt(H.current,_);$.diff.updated.length>0&&(!!$.diff.updated[0].date?($.diff.updated[0].sort_order=Date.now(),await Ft($.diff),W()):(E($.newTransaction,$.data),Pt($.diff,$,E)))},[]),A=u.useCallback(_=>{const $=Pn(H.current,_);return E($.newTransaction,$.data),Pt($.diff,$,E),$.diff.added[0].id},[]),y=u.useCallback(_=>{const $=In(H.current,_);return E($.newTransaction,$.data),Pt($.diff,$,E),$.diff.added[0].id},[]),j=u.useCallback(async(_,$=null)=>{const Z=await V("rules-run",{transaction:_}),pe=ja(_,Z),se={..._};return pe&&(Object.keys(pe).forEach(q=>{(se[q]==null||se[q]===""||se[q]===0||se[q]===!1)&&(se[q]=pe[q])}),_.is_parent&&pe.subtransactions!==void 0&&$!==null&&(se.subtransactions=pe.subtransactions.map((q,me)=>({...se.subtransactions[me]||q,...q[$]!=null&&{[$]:q[$]}})))),se},[]),k=u.useCallback(_=>{ee("/payees",{state:{selectedPayee:_}})}),F=u.useCallback(_=>{ee(`/accounts/${_}`)}),Q=u.useCallback(_=>{J(Le("schedule-edit",{id:_}))}),ne=u.useCallback(_=>{Y({field:"notes",op:"matches",value:`(^|\\s|\\w|#)${Lo(_)}($|\\s|#)`,type:"string"})});return e.jsx(xs,{ref:n,transactions:s,loadMoreTransactions:o,accounts:r,categoryGroups:a,payees:d,showBalances:f,balances:c,showCleared:h,showAccount:w,showCategory:!0,currentAccountId:i&&i.id,currentCategoryId:l&&l.id,isAdding:p,isNew:S,isMatched:b,isFiltered:C,dateFormat:B,hideFraction:P,addNotification:R,headerContent:v,renderEmpty:N,onSave:x,onApplyRules:j,onSplit:y,onCloseAddTransaction:O,onAdd:L,onAddSplit:A,onManagePayees:k,onCreatePayee:z,style:{backgroundColor:m.tableBackground},onNavigateToTransferAccount:F,onNavigateToSchedule:Q,onNotesTagClick:ne,onSort:T,sortField:I,ascDesc:D})}function Qo({filterId:n,onFilterMenuSelect:t}){return e.jsx(je,{onMenuSelect:s=>{t(s)},items:n.id?n.id!==null&&n.status==="saved"?[{name:"rename-filter",text:"Rename"},{name:"delete-filter",text:"Delete"},je.line,{name:"save-filter",text:"Save new filter",disabled:!0},{name:"clear-filter",text:"Clear all conditions"}]:[{name:"rename-filter",text:"Rename"},{name:"update-filter",text:"Update condtions"},{name:"reload-filter",text:"Revert changes"},{name:"delete-filter",text:"Delete"},je.line,{name:"save-filter",text:"Save new filter"},{name:"clear-filter",text:"Clear all conditions"}]:[{name:"save-filter",text:"Save new filter"},{name:"clear-filter",text:"Clear all conditions"}]})}function Vo({menuItem:n,name:t,setName:s,adding:o,onAddUpdate:i,err:r}){const l=u.useRef(null);return u.useEffect(()=>{l.current&&l.current.focus()},[]),e.jsxs(e.Fragment,{children:[n!=="update-filter"&&e.jsx("form",{children:e.jsxs(Je,{direction:"row",justify:"flex-end",align:"center",style:{padding:10},children:[e.jsxs(Sa,{style:{flex:1},children:[e.jsx(Ca,{title:"Filter Name",htmlFor:"name-field",style:{userSelect:"none"}}),e.jsx(rt,{id:"name-field",inputRef:l,defaultValue:t||"",onChangeValue:s})]}),e.jsx(K,{type:"primary",style:{marginTop:18},onClick:a=>{a.preventDefault(),i()},children:o?"Add":"Update"})]})}),r&&e.jsx(Je,{direction:"row",align:"center",style:{padding:10},children:e.jsx(X,{style:{color:m.errorText},children:r})})]})}function Zo({conditions:n,conditionsOp:t,filterId:s,onClearFilters:o,onReloadSavedFilter:i,savedFilters:r}){const[l,a]=u.useState(!1),[d,c]=u.useState(!1),[f,h]=u.useState(!1),w=u.useRef(null),[v,p]=u.useState(null),[S,b]=u.useState(""),[C,B]=u.useState(s.name),P=s.id;let R;const N=async I=>{switch(b(I),I){case"rename-filter":p(null),c(!1),h(!1),a(!0);break;case"delete-filter":h(!1),await V("filter-delete",P),o();break;case"update-filter":p(null),c(!1),h(!1),R={conditions:n,conditionsOp:t,id:s.id,name:s.name,status:"saved"};const D=await Mt("filter-update",{state:R,filters:[...r]});if(D.error){p(D.error.message),a(!0);return}i(R,"update");break;case"save-filter":p(null),c(!0),h(!1),a(!0);break;case"reload-filter":h(!1),R={...R,status:"saved"},i(R,"reload");break;case"clear-filter":h(!1),o();break}};async function T(){if(d){const E={conditions:n,conditionsOp:t,name:C,status:"saved"},W=await Mt("filter-create",{state:E,filters:[...r]});if(W.error){p(W.error.message),a(!0);return}a(!1),i({...E,id:W.data});return}const I={conditions:s.conditions,conditionsOp:s.conditionsOp,id:s.id,name:C},D=await Mt("filter-update",{state:I,filters:[...r]});if(D.error){p(D.error.message),a(!0);return}a(!1),i(I)}return e.jsxs(g,{children:[n.length>0&&e.jsxs(K,{ref:w,type:"bare",style:{marginTop:10},onClick:()=>{h(!0)},children:[e.jsxs(X,{style:{maxWidth:150,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",flexShrink:0},children:[s.id?s.name:"Unsaved filter"," "]}),s.id&&s.status!=="saved"&&e.jsx(X,{children:"(modified) "}),e.jsx(bn,{width:8,height:8,style:{marginRight:5}})]}),e.jsx(ie,{triggerRef:w,isOpen:f,onOpenChange:()=>h(!1),style:{width:200},children:e.jsx(Qo,{filterId:s,onFilterMenuSelect:N})}),e.jsx(ie,{triggerRef:w,isOpen:l,onOpenChange:()=>a(!1),style:{width:325},children:e.jsx(Vo,{menuItem:S,name:C,setName:B,adding:d,onAddUpdate:T,err:v})})]})}function qo({conditions:n,conditionsOp:t,onUpdateFilter:s,onDeleteFilter:o,onClearFilters:i,onReloadSavedFilter:r,filterId:l,savedFilters:a,onConditionsOpChange:d}){return e.jsx(g,{children:e.jsxs(Je,{spacing:2,direction:"row",justify:"flex-start",align:"flex-start",children:[e.jsx(Ja,{conditions:n,conditionsOp:t,onConditionsOpChange:d,onUpdate:s,onDelete:o}),e.jsx(g,{style:{flex:1}}),e.jsx(Zo,{conditions:n,conditionsOp:t,filterId:l,onClearFilters:i,onReloadSavedFilter:r,savedFilters:a})]})})}function Ko({getTransaction:n,onShow:t,onDuplicate:s,onDelete:o,onEdit:i,onUnlink:r,onCreateRule:l,onSetTransfer:a,onScheduleAction:d,showMakeTransfer:c,onMakeAsSplitTransaction:f,onMakeAsNonSplitTransactions:h}){const w=Qe(),v=Ut(),p=u.useMemo(()=>[...v],[v]),S=u.useMemo(()=>{const T=p;return{preview:!!T.find(I=>He(I)),trans:!!T.find(I=>!He(I))}},[p]),b=u.useMemo(()=>p.map(I=>n(I)).some(I=>I&&I.is_child),[p,n]),C=u.useMemo(()=>!S.preview&&p.every(T=>{const I=n(T);return I&&I.schedule}),[S.preview,p,n]),B=u.useMemo(()=>{if(p.length!==2)return!1;const T=n(p[0]),I=n(p[1]);return!T||!I?!1:ls(T,I)},[p,n]),P=u.useMemo(()=>{if(p.length<=1||S.preview)return!1;const T=p.map(O=>n(O)),[I]=T,D=T.every(O=>O&&O.date===I.date&&O.account===I.account),E=T.every(O=>O&&!O.is_parent&&!O.is_child),W=T.every(O=>O&&!O.reconciled);return D&&E&&W},[p,S,n]),R=u.useMemo(()=>{if(p.length===0||S.preview)return!1;const T=p.map(E=>n(E)),I=T.every(E=>E&&!E.reconciled),D=T.every(E=>E&&(E.is_parent||E.is_child));return I&&D},[p,S,n]),N={enabled:S.trans,scopes:["app"]};return re("f",()=>t(p),N,[t,p]),re("d",()=>o(p),N,[o,p]),re("a",()=>i("account",p),N,[i,p]),re("p",()=>i("payee",p),N,[i,p]),re("n",()=>i("notes",p),N,[i,p]),re("c",()=>i("category",p),N,[i,p]),re("l",()=>i("cleared",p),N,[i,p]),e.jsx(Ta,{name:"transactions",items:[...S.trans?[{name:"show",text:"Show",key:"F"},{name:"duplicate",text:"Duplicate",disabled:b},{name:"delete",text:"Delete",key:"D"},...C?[{name:"view-schedule",text:"View schedule",disabled:p.length>1},{name:"unlink-schedule",text:"Unlink schedule"}]:[{name:"link-schedule",text:"Link schedule"},{name:"create-rule",text:"Create rule"}],...c?[{name:"set-transfer",text:"Make transfer",disabled:!B}]:[],...P?[{name:"make-as-split-transaction",text:"Make as split transaction"}]:[],...R?[{name:"unsplit-transactions",text:"Unsplit transaction"+(p.length>1?"s":"")}]:[],je.line,{type:je.label,name:"Edit field"},{name:"date",text:"Date"},{name:"account",text:"Account",key:"A"},{name:"payee",text:"Payee",key:"P"},{name:"notes",text:"Notes",key:"N"},{name:"category",text:"Category",key:"C"},{name:"amount",text:"Amount"},{name:"cleared",text:"Cleared",key:"L"}]:[{name:"view-schedule",text:"View schedule"},{name:"post-transaction",text:"Post transaction"},{name:"skip",text:"Skip scheduled date"}]],onSelect:T=>{switch(T){case"show":t(p);break;case"duplicate":s(p);break;case"delete":o(p);break;case"make-as-split-transaction":f(p);break;case"unsplit-transactions":h(p);break;case"post-transaction":case"skip":d(T,p);break;case"view-schedule":const I=p[0];let D;if(He(I))D=I.split("/")[1];else{const E=n(I);D=E&&E.schedule}D&&w(Le("schedule-edit",{id:D}));break;case"link-schedule":w(Le("schedule-link",{transactionIds:p,getTransaction:n}));break;case"unlink-schedule":r(p);break;case"create-rule":l(p);break;case"set-transfer":a(p);break;default:i(T,p)}}})}function Ct({name:n,balance:t,isExactBalance:s=!0}){const o=at();return e.jsxs(X,{style:{marginLeft:15,borderRadius:4,padding:"4px 6px",color:m.pillText,backgroundColor:m.pillBackground},children:[n," ",e.jsx(Ba,{children:e.jsxs(X,{style:{fontWeight:600},children:[!s&&"~ ",o(t,"financial")]})})]})}function Yo({selectedItems:n,account:t}){const s=`selected-balance-${[...n].join("-")}`,o=Ee({name:s,query:xe("transactions").filter({id:{$oneof:[...n]},parent_id:{$oneof:[...n]}}).select("id")}),i=new Set((o||[]).map(w=>w.id)),r=[...n].filter(w=>!i.has(w));let l=Ee({name:s+"-sum",query:xe("transactions").filter({id:{$oneof:r}}).options({splits:"all"}).calculate({$sum:"$amount"})}),a=null;const d=En(),c=d?d.schedules:[],f=[...n].filter(w=>He(w)).map(w=>w.slice(8));let h=!0;for(const w of c)f.includes(w.id)&&(w._amountOp==="isbetween"&&(h=!1),!t||t.id===w._account?a+=St(w._amount):a-=St(w._amount));if(l==null){if(a==null)return null;l=a}else a!=null&&(l+=a);return e.jsx(Ct,{name:"Selected balance:",balance:l,isExactBalance:h})}function Xo({filteredAmount:n}){return e.jsx(Ct,{name:"Filtered balance:",balance:n||0,isExactBalance:!0})}function Jo({balanceQuery:n}){const t=Ee({name:n.name+"-cleared",query:n.query.filter({cleared:!0})}),s=Ee({name:n.name+"-uncleared",query:n.query.filter({cleared:!1})});return e.jsxs(g,{style:{flexDirection:"row"},children:[e.jsx(Ct,{name:"Cleared total:",balance:t}),e.jsx(Ct,{name:"Uncleared total:",balance:s})]})}function ei({balanceQuery:n,showExtraBalances:t,onToggleExtraBalances:s,account:o,isFiltered:i,filteredAmount:r}){const l=Ut(),a=u.useRef(null),d=ka(a);return e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",marginTop:-5,marginLeft:-5},children:[e.jsxs(be,{ref:a,"data-testid":"account-balance",variant:"bare",onPress:s,style:{paddingTop:1,paddingBottom:1},children:[e.jsx(ve,{binding:{...n,value:0},type:"financial",style:{fontSize:22,fontWeight:400},getStyle:c=>({color:c<0?m.errorText:c>0?m.noticeTextLight:m.pageTextSubdued}),privacyFilter:{blurIntensity:5}}),e.jsx(ao,{style:{width:10,height:10,marginLeft:10,color:m.pillText,transform:t?"rotateZ(180deg)":"rotateZ(0)",opacity:d||l.size>0||t?1:0}})]}),t&&e.jsx(Jo,{balanceQuery:n}),l.size>0&&e.jsx(Yo,{selectedItems:l,account:o}),i&&e.jsx(Xo,{filteredAmount:r})]})}function ti({balanceQuery:n,targetBalance:t,onDone:s,onCreateTransaction:o}){const i=Ee({name:n.name+"-cleared",value:0,query:n.query.filter({cleared:!0})}),r=at(),l=t-i;return e.jsx(g,{style:{flexDirection:"row",alignSelf:"center",backgroundColor:m.tableBackground,...G.shadow,borderRadius:4,marginTop:5,marginBottom:15,padding:10},children:e.jsxs(g,{style:{flexDirection:"row",alignItems:"center"},children:[l===0?e.jsxs(g,{style:{color:m.noticeTextLight,flex:1,flexDirection:"row",alignItems:"center",justifyContent:"center"},children:[e.jsx(Ma,{style:{width:13,height:13,color:"inherit",marginRight:3}}),"All reconciled!"]}):e.jsx(g,{style:{color:m.tableText},children:e.jsxs(X,{style:{fontStyle:"italic",textAlign:"center"},children:["Your cleared balance"," ",e.jsx("strong",{children:r(i,"financial")})," needs"," ",e.jsx("strong",{children:(l>0?"+":"")+r(l,"financial")})," ","to match",e.jsx("br",{})," your bank’s balance of"," ",e.jsx(X,{style:{fontWeight:700},children:r(t,"financial")})]})}),e.jsx(g,{style:{marginLeft:15},children:e.jsx(be,{variant:"primary",onPress:s,children:"Done Reconciling"})}),l!==0&&e.jsx(g,{style:{marginLeft:15},children:e.jsx(be,{onPress:()=>o(l),children:"Create Reconciliation Transaction"})})]})})}function ni({account:n,onReconcile:t,onClose:s}){const o=Ra(n),i=Ee({name:o.name+"-cleared",value:null,query:o.query.filter({cleared:!0})}),r=at(),[l,a]=u.useState(null),[d,c]=u.useState(!1);function f(){if(l===""){c(!0);return}const h=l!=null?Aa(l):i;t(h),s()}return e.jsxs(g,{style:{padding:"5px 8px"},children:[e.jsx(X,{children:"Enter the current balance of your bank account that you want to reconcile with:"}),i!=null&&e.jsx(it,{children:e.jsx(rt,{defaultValue:r(i,"financial"),onChangeValue:a,style:{margin:"7px 0"},focused:d,onEnter:f})}),e.jsx(be,{variant:"primary",onPress:f,children:"Reconcile"})]})}function si({tableRef:n,editingName:t,isNameEditable:s,workingHard:o,accountName:i,account:r,filterId:l,savedFilters:a,accountsSyncing:d,failedAccounts:c,accounts:f,transactions:h,showBalances:w,showExtraBalances:v,showCleared:p,showReconciled:S,showEmptyMessage:b,balanceQuery:C,reconcileAmount:B,canCalculateBalance:P,isFiltered:R,filteredAmount:N,isSorted:T,search:I,filterConditions:D,filterConditionsOp:E,pushModal:W,onSearch:O,onAddTransaction:z,onShowTransactions:Y,onDoneReconciling:J,onCreateReconciliationTransaction:H,onToggleExtraBalances:ee,onSaveName:L,onExposeName:x,onSync:A,onImport:y,onMenuSelect:j,onReconcile:k,onBatchDelete:F,onBatchDuplicate:Q,onBatchEdit:ne,onBatchUnlink:_,onCreateRule:$,onApplyFilter:Z,onUpdateFilter:pe,onClearFilters:se,onReloadSavedFilter:q,onConditionsOpChange:me,onDeleteFilter:U,onScheduleAction:Ze,onSetTransfer:_e,onMakeAsSplitTransaction:Fe,onMakeAsNonSplitTransactions:ct}){const[dt,oe]=u.useState(!1),Ne=u.useRef(null),ye=u.useRef(null),Se=Yt(),ut=Ln(),ht=ut!=="no-server",we=ut==="offline",[Xt,Tt]=ce("expand-splits");let Ce=r&&r.account_id&&ht;r||(Ce=!!f.find(le=>!!le.account_id)&&ht);const pt=!r;function fe(){n.current&&(Se.dispatch({type:"switch-mode",id:n.current.getScrolledItem()}),Tt(Se.state.mode!=="expand"))}return re("ctrl+f, cmd+f, meta+f",()=>{Ne.current&&Ne.current.focus()},{enableOnFormTags:!0,preventDefault:!0,scopes:["app"]},[Ne]),re("t",()=>z(),{preventDefault:!0,scopes:["app"]},[z]),re("ctrl+i, cmd+i, meta+i",()=>y(),{scopes:["app"]},[y]),re("ctrl+b, cmd+b, meta+b",()=>A(),{enabled:Ce&&!we,preventDefault:!0,scopes:["app"]},[A]),e.jsxs(e.Fragment,{children:[e.jsxs(g,{style:{...G.pageContent,paddingBottom:10,flexShrink:0},children:[e.jsx(g,{style:{marginTop:2,marginBottom:10,alignItems:"flex-start"},children:e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",gap:3},children:[!!r?.bank&&e.jsx(g,{style:{backgroundColor:d.includes(r.id)?m.sidebarItemBackgroundPending:c.has(r.id)?m.sidebarItemBackgroundFailed:m.sidebarItemBackgroundPositive,marginRight:"4px",width:8,height:8,borderRadius:8}}),t?e.jsx(it,{children:e.jsx(rt,{defaultValue:i,onEnter:le=>L(le.target.value),onBlur:le=>L(le.target.value),onEscape:()=>x(!1),style:{fontSize:25,fontWeight:500,marginTop:-3,marginBottom:-4,marginLeft:-6,paddingTop:2,paddingBottom:2,width:Math.max(20,i.length)+"ch"}})}):s?e.jsxs(g,{style:{flexDirection:"row",alignItems:"center",gap:3,"& .hover-visible":{opacity:0,transition:"opacity .25s"},"&:hover .hover-visible":{opacity:1}},children:[e.jsx(g,{style:{fontSize:25,fontWeight:500,marginRight:5,marginBottom:-1},"data-testid":"account-name",children:r&&r.closed?"Closed: "+i:i}),r&&e.jsx(lt,{id:`account-${r.id}`,defaultColor:m.pageTextSubdued}),e.jsx(be,{variant:"bare","aria-label":"Edit account name",className:"hover-visible",onPress:()=>x(!0),children:e.jsx(uo,{style:{width:11,height:11,color:m.pageTextSubdued}})})]}):e.jsx(g,{style:{fontSize:25,fontWeight:500,marginBottom:-1},"data-testid":"account-name",children:r&&r.closed?"Closed: "+i:i})]})}),e.jsx(ei,{balanceQuery:C,showExtraBalances:v,onToggleExtraBalances:ee,account:r,isFiltered:R,filteredAmount:N}),e.jsxs(Je,{spacing:2,direction:"row",align:"center",style:{marginTop:12},children:[(r&&!r.closed||Ce)&&e.jsx(be,{variant:"bare",onPress:Ce?A:y,isDisabled:Ce&&we,children:Ce?e.jsxs(e.Fragment,{children:[e.jsx(Ia,{width:13,height:13,animating:r?d.includes(r.id):d.length>0,style:{marginRight:4}})," ",we?"Bank Sync Offline":"Bank Sync"]}):e.jsxs(e.Fragment,{children:[e.jsx(lo,{width:13,height:13,style:{marginRight:4}})," ","Import"]})}),!b&&e.jsxs(be,{variant:"bare",onPress:z,children:[e.jsx(Pa,{width:10,height:10,style:{marginRight:3}})," Add New"]}),e.jsx(g,{style:{flexShrink:0},children:e.jsx(eo,{onApply:Z,type:"accounts"})}),e.jsx(g,{style:{flex:1}}),e.jsx(kn,{placeholder:"Search",value:I,onChange:O,inputRef:Ne}),o?e.jsx(g,{children:e.jsx(Da,{style:{width:16,height:16}})}):e.jsx(Ko,{getTransaction:le=>h.find(ft=>ft.id===le),onShow:Y,onDuplicate:Q,onDelete:F,onEdit:ne,onUnlink:_,onCreateRule:$,onSetTransfer:_e,onScheduleAction:Ze,pushModal:W,showMakeTransfer:pt,onMakeAsSplitTransaction:Fe,onMakeAsNonSplitTransactions:ct}),e.jsx(be,{variant:"bare","aria-label":Se.state.mode==="collapse"?"Collapse split transactions":"Expand split transactions",isDisabled:I!==""||D.length>0,style:{padding:6,marginLeft:10},onPress:fe,children:e.jsx(g,{title:Se.state.mode==="collapse"?"Collapse split transactions":"Expand split transactions",children:Se.state.mode==="collapse"?e.jsx(io,{style:{width:14,height:14}}):e.jsx(oo,{style:{width:14,height:14}})})}),r?e.jsxs(g,{children:[e.jsx(fn,{ref:ye,onClick:()=>oe(!0)}),e.jsx(ie,{triggerRef:ye,style:{width:275},isOpen:dt,onOpenChange:()=>oe(!1),children:e.jsx(ai,{account:r,canSync:Ce,canShowBalances:P(),isSorted:T,showBalances:w,showCleared:p,showReconciled:S,onMenuSelect:le=>{oe(!1),j(le)},onReconcile:k,onClose:()=>oe(!1)})})]}):e.jsxs(g,{children:[e.jsx(fn,{ref:ye,onClick:()=>oe(!0)}),e.jsx(ie,{triggerRef:ye,isOpen:dt,onOpenChange:()=>oe(!1),children:e.jsx(je,{onMenuSelect:le=>{oe(!1),j(le)},items:[T&&{name:"remove-sorting",text:"Remove all sorting"},{name:"export",text:"Export"}]})})]})]}),D?.length>0&&e.jsx(qo,{conditions:D,conditionsOp:E,onUpdateFilter:pe,onDeleteFilter:U,onClearFilters:se,onReloadSavedFilter:q,filterId:l,savedFilters:a,onConditionsOpChange:me})]}),B!=null&&e.jsx(ti,{targetBalance:B,balanceQuery:C,onDone:J,onCreateTransaction:H})]})}function ai({account:n,canSync:t,showBalances:s,canShowBalances:o,showCleared:i,showReconciled:r,onClose:l,isSorted:a,onReconcile:d,onMenuSelect:c}){const[f,h]=u.useState("default"),w=Ln();return f==="reconcile"?e.jsx(ni,{account:n,onClose:l,onReconcile:d}):e.jsx(je,{onMenuSelect:v=>{v==="reconcile"?h("reconcile"):c(v)},items:[a&&{name:"remove-sorting",text:"Remove all sorting"},o&&{name:"toggle-balance",text:(s?"Hide":"Show")+" running balance"},{name:"toggle-cleared",text:(i?"Hide":"Show")+" “cleared” checkboxes"},{name:"toggle-reconciled",text:(r?"Hide":"Show")+" reconciled transactions"},{name:"export",text:"Export"},{name:"reconcile",text:"Reconcile"},n&&!n.closed&&(t?{name:"unlink",text:"Unlink account"}:w==="online"&&{name:"link",text:"Link account"}),n.closed?{name:"reopen",text:"Reopen account"}:{name:"close",text:"Close account"}].filter(v=>v)})}function oi({onAdd:n}){return e.jsx(g,{style:{color:m.tableText,backgroundColor:m.tableBackground,flex:1,alignItems:"center",borderTopWidth:1,borderColor:m.tableBorder},children:e.jsxs(g,{style:{width:550,marginTop:75,fontSize:15,alignItems:"center"},children:[e.jsxs(X,{style:{textAlign:"center",lineHeight:"1.4em"},children:["For Actual to be useful, you need to ",e.jsx("strong",{children:"add an account"}),". You can link an account to automatically download transactions, or manage it locally yourself."]}),e.jsx(be,{variant:"primary",style:{marginTop:20},onPress:n,children:"Add account"}),e.jsx(g,{style:{marginTop:20,fontSize:13,color:m.tableTextLight},children:"In the future, you can add accounts from the sidebar."})]})})}function ii({account:n={},transactions:t,balances:s,showBalances:o,filtered:i,children:r}){const l=n.id,a=Ya().map(w=>({...w,_inverse:l?l!==w.account:!1}));t??=[];let d=u.useMemo(()=>o&&s&&t?.length>0?s[t[0].id]?.balance??0:0,[o,s,t]);const c=u.useMemo(()=>{if(!o)return null;const w=[...a].reverse().map(v=>{const p=(v._inverse?-1:1)*St(v.amount);return{balance:d+=p,id:v.id}});return _n(w)},[o,a,d]),f=u.useMemo(()=>!i&&a.length>0?a.concat(t):t,[i,a,t]),h=u.useMemo(()=>!i&&c&&s?{...c,...s}:s,[i,c,s]);return a?r(f,h):r(t,s)}function xn(n){switch(n){case"account":return"account.name";case"payee":return"payee.name";case"category":return"category.name";case"payment":return"amount";case"deposit":return"amount";default:return n}}class ri extends u.PureComponent{constructor(t){super(t),this.paged=null,this.table=u.createRef(),this.animated=!0,this.state={search:"",filterConditions:t.filterConditions||[],filterId:[],filterConditionsOp:"and",loading:!0,workingHard:!1,reconcileAmount:null,transactions:[],transactionsCount:0,showBalances:t.showBalances,balances:null,showCleared:t.showCleared,showReconciled:t.showReconciled,editingName:!1,isAdding:!1,latestDate:null,sort:[],filteredAmount:null}}async componentDidMount(){const t=i=>{if(i.includes("transactions")||i.includes("category_mapping")||i.includes("payee_mapping"))return this.refetchTransactions()},s=async({tables:i,messages:r})=>{await t(i);let l;if(r.every(a=>a.dataset==="transactions")&&!r.find(a=>a.column==="tombstone")){const a=r.filter(d=>d.dataset==="transactions"&&d.column!=="tombstone");l=a.length===1?a[0].row:null}this.table.current&&(this.table.current.edit(null),l&&this.table.current.scrollTo(l)),this.props.setLastUndoState(null)},o=[Dt("undo-event",s)];this.unlisten=()=>{o.forEach(i=>i())},await this.props.initiallyLoadPayees(),await this.fetchTransactions(this.state.filterConditions),this.props.lastUndoState&&this.props.lastUndoState.current&&s(this.props.lastUndoState.current)}componentDidUpdate(t){this.state.isAdding&&this.props.accountId!==t.accountId&&this.setState({isAdding:!1}),t.modalShowing&&!this.props.modalShowing&&setTimeout(()=>{this.refetchTransactions()},100),this.props.accountId!==t.accountId&&this.setState({sort:[],search:"",filterConditions:[]})}componentWillUnmount(){this.unlisten&&this.unlisten(),this.paged&&this.paged.unsubscribe()}fetchAllIds=async()=>{const{data:t}=await de(this.paged.getQuery().select("id"));return t.reduce((s,o)=>(s.push(o.id),o.subtransactions.forEach(i=>s.push(i.id)),s),[])};refetchTransactions=async()=>{this.paged?.run()};fetchTransactions=t=>{const s=this.makeRootQuery();this.rootQuery=this.currentQuery=s,t?this.applyFilters(t):this.updateQuery(s),this.props.accountId&&this.props.markAccountRead(this.props.accountId)};makeRootQuery=()=>{const t=this.props.accountId;return Ga(t)};updateQuery(t,s){this.paged&&this.paged.unsubscribe(),this.state.showReconciled||(t=t.filter({reconciled:{$eq:!1}})),this.paged=Ua(t.select("*"),async(o,i)=>{const r=i==null;r&&(this.table.current?.setRowAnimation(!1),s?this.props.splitsExpandedDispatch({type:"set-mode",mode:"collapse"}):this.props.splitsExpandedDispatch({type:"set-mode",mode:this.props.expandSplits?"expand":"collapse"})),this.setState({transactions:o,transactionCount:this.paged.getTotalCount(),transactionsFiltered:s,loading:!1,workingHard:!1,balances:this.state.showBalances?await this.calculateBalances():null,filteredAmount:await this.getFilteredAmount()},()=>{r&&this.table.current?.scrollToTop(),setTimeout(()=>{this.table.current?.setRowAnimation(!0)},0)})},{pageCount:150,onlySync:!0,mapper:Ie})}UNSAFE_componentWillReceiveProps(t){this.props.accountId!==t.accountId&&this.setState({editingName:!1,loading:!0,search:"",showBalances:t.showBalances,balances:null,showCleared:t.showCleared,showReconciled:t.showReconciled,reconcileAmount:null},()=>{this.fetchTransactions()})}onSearch=t=>{this.paged.unsubscribe(),this.setState({search:t},this.onSearchDone)};onSearchDone=za.debounce(()=>{this.state.search===""?this.updateQuery(this.currentQuery,this.state.filterConditions.length>0):this.updateQuery(Qa(this.currentQuery,this.state.search,this.props.dateFormat),!0)},150);onSync=async()=>{const t=this.props.accountId,s=this.props.accounts.find(o=>o.id===t);await this.props.syncAndDownload(s?s.id:void 0)};onImport=async()=>{const t=this.props.accountId,s=this.props.accounts.find(i=>i.id===t),o=await this.props.getCategories();if(s){const i=await window.Actual?.openFileDialog({filters:[{name:"Financial Files",extensions:["qif","ofx","qfx","csv","tsv","xml"]}]});i&&this.props.pushModal("import-transactions",{accountId:t,categories:o,filename:i[0],onImported:r=>{r&&this.fetchTransactions()}})}};onExport=async t=>{const s=await V("transactions-export-query",{query:this.currentQuery.serialize()}),i=`${t&&t.replace(/[()]/g,"").replace(/\s+/g,"-")||"transactions"}.csv`;window.Actual?.saveFile(s,i,"Export Transactions")};onTransactionsChange=(t,s)=>{this.paged.optimisticUpdate(o=>t._deleted?o.filter(i=>i.id!==t.id):o.map(i=>i.id===t.id?t:i),()=>s),this.props.updateNewTransactions(t.id)};canCalculateBalance=()=>{const t=this.props.accountId;return this.props.accounts.find(o=>o.id===t)&&this.state.search===""&&this.state.filterConditions.length===0&&(this.state.sort.length===0||this.state.sort.field==="date"&&this.state.sort.ascDesc==="desc")};async calculateBalances(){if(!this.canCalculateBalance())return null;const{data:t}=await de(this.paged.getQuery().options({splits:"none"}).select([{balance:{$sumOver:"$amount"}}]));return _n(t)}onAddTransaction=()=>{this.setState({isAdding:!0})};onExposeName=t=>{this.setState({editingName:t})};onSaveName=t=>{if(t.trim().length){const s=this.props.accountId,o=this.props.accounts.find(i=>i.id===s);this.props.updateAccount({...o,name:t}),this.setState({editingName:!1})}};onToggleExtraBalances=()=>{const{accountId:t,showExtraBalances:s}=this.props,o="show-extra-balances-"+t||"all-accounts";this.props.savePrefs({[o]:!s})};onMenuSelect=async t=>{const s=this.props.accountId,o=this.props.accounts.find(i=>i.id===s);switch(t){case"link":this.props.pushModal("add-account",{upgradingAccountId:s});break;case"unlink":this.props.pushModal("confirm-unlink-account",{accountName:o.name,onUnlink:()=>{this.props.unlinkAccount(s)}});break;case"close":this.props.openAccountCloseModal(s);break;case"reopen":this.props.reopenAccount(s);break;case"export":const i=this.getAccountTitle(o,s);this.onExport(i);break;case"toggle-balance":this.state.showBalances?(this.props.savePrefs({["show-balances-"+s]:!1}),this.setState({showBalances:!1,balances:null})):(this.props.savePrefs({["show-balances-"+s]:!0}),this.setState({transactions:[],transactionCount:0,filterConditions:[],search:"",sort:[],showBalances:!0},()=>{this.fetchTransactions()}));break;case"remove-sorting":{this.setState({sort:[]},()=>{const r=this.state.filterConditions;r.length>0?this.applyFilters([...r]):this.fetchTransactions(),this.state.search!==""&&this.onSearch(this.state.search)});break}case"toggle-cleared":this.state.showCleared?(this.props.savePrefs({["hide-cleared-"+s]:!0}),this.setState({showCleared:!1})):(this.props.savePrefs({["hide-cleared-"+s]:!1}),this.setState({showCleared:!0}));break;case"toggle-reconciled":this.state.showReconciled?(this.props.savePrefs({["hide-reconciled-"+s]:!0}),this.setState({showReconciled:!1},()=>this.fetchTransactions(this.state.filterConditions))):(this.props.savePrefs({["hide-reconciled-"+s]:!1}),this.setState({showReconciled:!0},()=>this.fetchTransactions(this.state.filterConditions)));break}};getAccountTitle(t,s){const{filterName:o}=this.props.location.state||{};return o||(t?t.name:s==="budgeted"?"Budgeted Accounts":s==="offbudget"?"Off Budget Accounts":s==="uncategorized"?"Uncategorized":s?null:"All Accounts")}getBalanceQuery(t,s){return{name:`balance-query-${s}`,query:this.makeRootQuery().calculate({$sum:"$amount"})}}getFilteredAmount=async()=>{const{data:t}=await de(this.paged.getQuery().calculate({$sum:"$amount"}));return t};isNew=t=>this.props.newTransactions.includes(t);isMatched=t=>this.props.matchedTransactions.includes(t);onCreatePayee=t=>t.trim()!==""?this.props.createPayee(t):null;lockTransactions=async()=>{this.setState({workingHard:!0});const{accountId:t}=this.props,{data:s}=await de(xe("transactions").filter({cleared:!0,reconciled:!1,account:t}).select("*").options({splits:"grouped"}));let o=Ie(s);const i={updated:[]};o.forEach(r=>{const{diff:l}=vt(o,{...r,reconciled:!0});o=xt(l,o),i.updated=i.updated?i.updated.concat(l.updated):l.updated}),await V("transactions-batch-update",i),await this.refetchTransactions()};onReconcile=async t=>{this.setState(({showCleared:s})=>({reconcileAmount:t,showCleared:!0,prevShowCleared:s}))};onDoneReconciling=async()=>{const{accountId:t}=this.props,{reconcileAmount:s}=this.state,{data:o}=await de(xe("transactions").filter({cleared:!0,account:t}).select("*").options({splits:"grouped"})),i=Ie(o);let r=0;i.forEach(a=>{a.is_parent||(r+=a.amount)}),s-r===0&&await this.lockTransactions(),this.setState({reconcileAmount:null,showCleared:this.state.prevShowCleared})};onCreateReconciliationTransaction=async t=>{const s=Lt([{id:"temp",account:this.props.accountId,cleared:!0,reconciled:!1,amount:t,date:zt(),notes:"Reconciliation balance adjustment"}]);this.setState({transactions:[...s,...this.state.transactions]}),await V("transactions-batch-update",{added:s}),await this.refetchTransactions()};onShowTransactions=async t=>{this.onApplyFilter({customName:"Selected transactions",queryFilter:{id:{$oneof:t}}})};onBatchEdit=async(t,s)=>{const{data:o}=await de(xe("transactions").filter({id:{$oneof:s}}).select("*").options({splits:"grouped"})),i=Ie(o),r=async(c,f,h)=>{let w=i;const v=f===null?"":f;this.setState({workingHard:!0});const p={deleted:[],updated:[]};c==="cleared"&&(f=!!w.find(b=>!b.cleared));const S=new Set(s);w.forEach(b=>{if(c==="cleared"&&b.reconciled||!S.has(b.id))return;c==="notes"&&(h==="prepend"?f=b.notes===null?v:v+" "+b.notes:h==="append"?f=b.notes===null?v:b.notes+" "+v:h==="replace"&&(f=v));const C={...b,[c]:f};c==="account"&&b.account!==f&&(C.reconciled=!1);const{diff:B}=vt(w,C);w=xt(B,w),p.deleted=p.deleted?p.deleted.concat(B.deleted):B.deleted,p.updated=p.updated?p.updated.concat(B.updated):B.updated,p.added=p.added?p.added.concat(B.added):B.added}),await V("transactions-batch-update",p),await this.refetchTransactions(),this.table.current&&this.table.current.edit(w[0].id,"select",!1)},l=()=>{this.props.pushModal("payee-autocomplete",{onSelect:c=>r(t,c)})},a=()=>{this.props.pushModal("account-autocomplete",{onSelect:c=>r(t,c)})},d=()=>{const c=i[0]?.date?Et(i[0]?.date):null,f=c&&i.every(h=>Et(h.date)===c);this.props.pushModal("category-autocomplete",{month:f?c:void 0,onSelect:h=>r(t,h)})};if((t==="amount"||t==="payee"||t==="account"||t==="date")&&i.filter(f=>f.reconciled).length>0){this.props.pushModal("confirm-transaction-edit",{onConfirm:()=>{t==="payee"?l():t==="account"?a():this.props.pushModal("edit-field",{name:t,onSubmit:r})},confirmReason:"batchEditWithReconciled"});return}t==="cleared"?r("cleared",null):t==="category"?d():t==="payee"?l():t==="account"?a():this.props.pushModal("edit-field",{name:t,onSubmit:r})};onBatchDuplicate=async t=>{const s=async o=>{this.setState({workingHard:!0});const{data:i}=await de(xe("transactions").filter({id:{$oneof:o}}).select("*").options({splits:"grouped"})),r={added:i.reduce((l,a)=>l.concat(Lt(hn(a))),[]).map(({sort_order:l,...a})=>({...a}))};await V("transactions-batch-update",r),await this.refetchTransactions()};await this.checkForReconciledTransactions(t,"batchDuplicateWithReconciled",s)};onBatchDelete=async t=>{const s=async o=>{this.setState({workingHard:!0});const{data:i}=await de(xe("transactions").filter({id:{$oneof:o}}).select("*").options({splits:"grouped"}));let r=Ie(i);const l=new Set(o),a={deleted:[],updated:[]};r.forEach(d=>{const c=d.parent_id;if(!l.has(d.id)||c&&l.has(c))return;const{diff:f}=An(r,d.id);r=xt(f,r),a.deleted=f.deleted?a.deleted.concat(f.deleted):f.deleted,a.updated=f.updated?a.updated.concat(f.updated):f.updated}),await V("transactions-batch-update",a),await this.refetchTransactions()};await this.checkForReconciledTransactions(t,"batchDeleteWithReconciled",s)};onMakeAsSplitTransaction=async t=>{this.setState({workingHard:!0});const{data:s}=await de(xe("transactions").filter({id:{$oneof:t}}).select("*").options({splits:"none"}));if(!s||s.length===0)return;const[o]=s,i={id:Va(),is_parent:!0,cleared:s.every(l=>!!l.cleared),date:o.date,account:o.account,amount:s.map(l=>l.amount).reduce((l,a)=>l+a,0)},r=s.map(l=>Za(i,l));await V("transactions-batch-update",{added:[i],updated:r}),this.refetchTransactions()};onMakeAsNonSplitTransactions=async t=>{this.setState({workingHard:!0});const{data:s}=await de(xe("transactions").filter({id:{$oneof:t}}).select("*").options({splits:"grouped"}));let o={updated:[],deleted:[]};const i=s.filter(l=>l.is_parent);for(const l of i){const a=hn(l),[d,...c]=a;if(t.includes(d.id)){const w=pn(c,a);o={updated:[...o.updated,...w.updated],deleted:[...o.deleted,...w.deleted]};continue}const f=c.filter(w=>t.includes(w.id));if(f.length===0)continue;const h=pn(f,a);o={updated:[...o.updated,...h.updated],deleted:[...o.deleted,...h.deleted]}}await V("transactions-batch-update",o),this.refetchTransactions();const r=o.updated.map(l=>l.id);this.dispatchSelected({type:"select-all",ids:r})};checkForReconciledTransactions=async(t,s,o)=>{const{data:i}=await de(xe("transactions").filter({id:{$oneof:t},reconciled:!0}).select("*").options({splits:"grouped"}));Ie(i).length>0?this.props.pushModal("confirm-transaction-edit",{onConfirm:()=>{o(t)},confirmReason:s}):o(t)};onBatchUnlink=async t=>{await V("transactions-batch-update",{updated:t.map(s=>({id:s,schedule:null}))}),await this.refetchTransactions()};onCreateRule=async t=>{const{data:s}=await de(xe("transactions").filter({id:{$oneof:t}}).select("*").options({splits:"grouped"})),o=Ie(s),i=o[0],r=o.filter(c=>c.parent_id===i.id),l=i.imported_payee?{field:"imported_payee",op:"is",value:i.imported_payee,type:"string"}:{field:"payee",op:"is",value:i.payee,type:"id"},a={field:"amount",op:"isapprox",value:i.amount,type:"number"},d={stage:null,conditionsOp:"and",conditions:[l,a],actions:[...r.length===0?[{op:"set",field:"category",value:i.category,type:"id",options:{splitIndex:0}}]:[],...r.flatMap((c,f)=>[{op:"set-split-amount",value:c.amount,options:{splitIndex:f+1,method:"fixed-amount"}},{op:"set",field:"category",value:c.category,type:"id",options:{splitIndex:f+1}}])]};this.props.pushModal("edit-rule",{rule:d})};onSetTransfer=async t=>{const s=async o=>{this.setState({workingHard:!0});const i=await this.props.getPayees(),{data:r}=await de(xe("transactions").filter({id:{$oneof:o}}).select("*")),[l,a]=r;if(r.length===2&&ls(l,a)){const d=i.find(h=>h.transfer_acct===l.account),c=i.find(h=>h.transfer_acct===a.account),f={updated:[{...l,payee:c.id,transfer_id:a.id},{...a,payee:d.id,transfer_id:l.id}]};await V("transactions-batch-update",f)}await this.refetchTransactions()};await this.checkForReconciledTransactions(t,"batchEditWithReconciled",s)};onConditionsOpChange=(t,s)=>{this.setState({filterConditionsOp:t}),this.setState({filterId:{...this.state.filterId,status:"changed"}}),this.applyFilters([...s]),this.state.search!==""&&this.onSearch(this.state.search)};onReloadSavedFilter=(t,s)=>{if(s==="reload"){const[o]=this.props.savedFilters.filter(i=>i.id===this.state.filterId.id);this.setState({filterConditionsOp:o.conditionsOp}),this.applyFilters([...o.conditions])}else t.status&&(this.setState({filterConditionsOp:t.conditionsOp}),this.applyFilters([...t.conditions]));this.setState({filterId:{...this.state.filterId,...t}})};onClearFilters=()=>{this.setState({filterConditionsOp:"and"}),this.setState({filterId:[]}),this.applyFilters([]),this.state.search!==""&&this.onSearch(this.state.search)};onUpdateFilter=(t,s)=>{this.applyFilters(this.state.filterConditions.map(o=>o===t?s:o)),this.setState({filterId:{...this.state.filterId,status:this.state.filterId&&"changed"}}),this.state.search!==""&&this.onSearch(this.state.search)};onDeleteFilter=t=>{this.applyFilters(this.state.filterConditions.filter(s=>s!==t)),this.state.filterConditions.length===1?(this.setState({filterId:[]}),this.setState({filterConditionsOp:"and"})):this.setState({filterId:{...this.state.filterId,status:this.state.filterId&&"changed"}}),this.state.search!==""&&this.onSearch(this.state.search)};onApplyFilter=async t=>{let s=this.state.filterConditions;if(t.customName&&(s=s.filter(o=>o.customName!==t.customName)),t.conditions){const o=t;this.setState({filterId:{...o,status:"saved"}}),this.setState({filterConditionsOp:o.conditionsOp}),this.applyFilters([...o.conditions])}else{const o=t;this.setState({filterId:{...this.state.filterId,status:this.state.filterId&&"changed"}}),this.applyFilters([...s,o])}this.state.search!==""&&this.onSearch(this.state.search)};onScheduleAction=async(t,s)=>{switch(t){case"post-transaction":for(const o of s){const i=o.split("/");await V("schedule/post-transaction",{id:i[1]})}this.refetchTransactions();break;case"skip":for(const o of s){const i=o.split("/");await V("schedule/skip-next-date",{id:i[1]})}break}};applyFilters=async t=>{if(t.length>0){const s=t.filter(r=>!!r.customName).map(r=>r.queryFilter),{filters:o}=await V("make-filters-from-conditions",{conditions:t.filter(r=>!r.customName)}),i=this.state.filterConditionsOp==="or"?"$or":"$and";this.currentQuery=this.rootQuery.filter({[i]:[...o,...s]}),this.setState({filterConditions:t},()=>{this.updateQuery(this.currentQuery,!0)})}else this.setState({transactions:[],transactionCount:0,filterConditions:t},()=>{this.fetchTransactions()});this.state.sort.length!==0&&this.applySort()};applySort=(t,s,o,i)=>{const r=this.state.filterConditions,l=r.length>0,a=xn(t||this.state.sort.field),d=s||this.state.sort.ascDesc,c=xn(o||this.state.sort.prevField),f=o?i:this.state.sort.prevAscDesc,h=function(p,S,b){S==="cleared"&&(p.currentQuery=p.currentQuery.orderBy({reconciled:b})),p.currentQuery=p.currentQuery.orderBy({[S]:b})},w=function(p,S,b){S==="cleared"?(p.currentQuery=p.rootQuery.orderBy({reconciled:b}),p.currentQuery=p.currentQuery.orderBy({cleared:b})):p.currentQuery=p.rootQuery.orderBy({[S]:b})},v=function(p,S,b){S&&(S==="cleared"&&(p.currentQuery=p.currentQuery.orderBy({reconciled:b})),p.currentQuery=p.currentQuery.orderBy({[S]:b}))};switch(!0){case!t:h(this,a,d);break;case l:this.applyFilters([...r]),h(this,a,d);break;case!l:w(this,a,d);break}v(this,c,f),this.updateQuery(this.currentQuery,l)};onSort=(t,s)=>{let o,i;t===this.state.sort.field?(o=this.state.sort.prevField,i=this.state.sort.prevAscDesc,this.setState({sort:{...this.state.sort,ascDesc:s}})):(o=this.state.sort.field,i=this.state.sort.ascDesc,this.setState({sort:{field:t,ascDesc:s,prevField:this.state.sort.field,prevAscDesc:this.state.sort.ascDesc}})),this.applySort(t,s,o,i),this.state.search!==""&&this.onSearch(this.state.search)};render(){const{accounts:t,categoryGroups:s,payees:o,dateFormat:i,hideFraction:r,addNotification:l,accountsSyncing:a,failedAccounts:d,replaceModal:c,showExtraBalances:f,accountId:h,categoryId:w}=this.props,{transactions:v,loading:p,workingHard:S,filterId:b,reconcileAmount:C,transactionsFiltered:B,editingName:P,showBalances:R,balances:N,showCleared:T,showReconciled:I,filteredAmount:D}=this.state,E=t.find(H=>H.id===h),W=this.getAccountTitle(E,h);if(!W&&!p)return e.jsx(qa,{to:"/accounts",replace:!0});const O=s.flatMap(H=>H.categories).find(H=>H.id===w),z=!p&&!h&&t.length===0,Y=h&&h!=="budgeted"&&h!=="offbudget"&&h!=="uncategorized",J=this.getBalanceQuery(E,h);return e.jsx(ii,{account:E,transactions:v,balances:N,showBalances:R,filtered:B,children:(H,ee)=>e.jsx(Ka,{name:"transactions",items:H,fetchAllIds:this.fetchAllIds,registerDispatch:L=>this.dispatchSelected=L,selectAllFilter:L=>!L._unmatched&&!L.is_parent,children:e.jsxs(g,{style:G.page,children:[e.jsx(si,{tableRef:this.table,editingName:P,isNameEditable:Y,workingHard:S,account:E,filterId:b,savedFilters:this.props.savedFilters,location:this.props.location,accountName:W,accountsSyncing:a,failedAccounts:d,accounts:t,transactions:v,showBalances:R,showExtraBalances:f,showCleared:T,showReconciled:I,showEmptyMessage:z,balanceQuery:J,canCalculateBalance:this.canCalculateBalance,filteredAmount:D,isFiltered:B,isSorted:this.state.sort.length!==0,reconcileAmount:C,search:this.state.search,filterConditions:this.state.filterConditions,filterConditionsOp:this.state.filterConditionsOp,savePrefs:this.props.savePrefs,pushModal:this.props.pushModal,onSearch:this.onSearch,onShowTransactions:this.onShowTransactions,onMenuSelect:this.onMenuSelect,onAddTransaction:this.onAddTransaction,onToggleExtraBalances:this.onToggleExtraBalances,onSaveName:this.onSaveName,onExposeName:this.onExposeName,onReconcile:this.onReconcile,onDoneReconciling:this.onDoneReconciling,onCreateReconciliationTransaction:this.onCreateReconciliationTransaction,onSync:this.onSync,onImport:this.onImport,onBatchDelete:this.onBatchDelete,onBatchDuplicate:this.onBatchDuplicate,onBatchEdit:this.onBatchEdit,onBatchUnlink:this.onBatchUnlink,onCreateRule:this.onCreateRule,onUpdateFilter:this.onUpdateFilter,onClearFilters:this.onClearFilters,onReloadSavedFilter:this.onReloadSavedFilter,onConditionsOpChange:this.onConditionsOpChange,onDeleteFilter:this.onDeleteFilter,onApplyFilter:this.onApplyFilter,onScheduleAction:this.onScheduleAction,onSetTransfer:this.onSetTransfer,onMakeAsSplitTransaction:this.onMakeAsSplitTransaction,onMakeAsNonSplitTransactions:this.onMakeAsNonSplitTransactions}),e.jsx(g,{style:{flex:1},children:e.jsx(zo,{tableRef:this.table,account:E,transactions:v,allTransactions:H,animated:this.animated,loadMoreTransactions:()=>this.paged&&this.paged.fetchNext(),accounts:t,category:O,categoryGroups:s,payees:o,balances:ee,showBalances:!!ee,showCleared:T,showAccount:!h||h==="offbudget"||h==="budgeted"||h==="uncategorized",isAdding:this.state.isAdding,isNew:this.isNew,isMatched:this.isMatched,isFiltered:B,dateFormat:i,hideFraction:r,addNotification:l,renderEmpty:()=>z?e.jsx(oi,{onAdd:()=>c("add-account")}):p?null:e.jsx(g,{style:{color:m.tableText,marginTop:20,textAlign:"center",fontStyle:"italic"},children:"No transactions"}),onSort:this.onSort,sortField:this.state.sort.field,ascDesc:this.state.sort.ascDesc,onChange:this.onTransactionsChange,onRefetch:this.refetchTransactions,onRefetchUpToRow:L=>this.paged.refetchUpToRow(L,{field:"date",order:"desc"}),onCloseAddTransaction:()=>this.setState({isAdding:!1}),onCreatePayee:this.onCreatePayee,onApplyFilter:this.onApplyFilter})})]})})})}}function li(n){const{dispatch:t}=Yt();return e.jsx(ri,{splitsExpandedDispatch:t,...n})}function gi(){const n=Ea(),t=La(),{grouped:s}=st(),o=$e(T=>T.queries.newTransactions),i=$e(T=>T.queries.matchedTransactions),r=_a(),l=Fa(),a=Na(),d=Oa()||"MM/dd/yyyy",[c=!1]=ce("hideFraction"),[f]=ce("expand-splits"),[h]=ce(`show-balances-${n.id}`),[w]=ce(`hide-cleared-${n.id}`),[v]=ce(`hide-reconciled-${n.id}`),[p]=ce(`show-extra-balances-${n.id||"all-accounts"}`),S=$e(T=>T.modals.modalStack.length>0),b=$e(T=>T.account.accountsSyncing),C=$e(T=>T.app.lastUndoState),B=t?.state?.filterConditions||[],P=Ha(),R=Tn(),N=Wa(n.id);return e.jsx($a,{transform:N,children:e.jsx(Ao,{initialMode:f?"collapse":"expand",children:e.jsx(li,{newTransactions:o,matchedTransactions:i,accounts:r,failedAccounts:a,dateFormat:d,hideFraction:c,expandSplits:f,showBalances:h,showCleared:!w,showReconciled:!v,showExtraBalances:p,payees:l,modalShowing:S,accountsSyncing:b,lastUndoState:C,filterConditions:B,categoryGroups:s,...R,accountId:n.id,categoryId:t?.state?.categoryId,location:t,savedFilters:P})})})}export{gi as Account,gi as Accounts,hi as Budget,fi as GoCardlessLink,pi as Schedules,yi as UserDirectoryPage};
//# sourceMappingURL=wide.OXzV7lGp.chunk.js.map
